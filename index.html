<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Olle Törnström">
<title>Query/Response for Spring® AMQP</title>
<style>
/*! Based on the Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

:root {
  --color-black: rgba(44, 62, 80, 0.9);

  --color-fuchsia-100: hsl(344, 97%, 95%);
  --color-fuchsia-200: hsl(344, 97%, 90%);
  --color-fuchsia-300: hsl(344, 97%, 85%);
  --color-fuchsia-400: hsl(344, 97%, 75%);
  --color-fuchsia-500: hsl(344, 97%, 64%);
  --color-fuchsia-600: hsl(344, 97%, 54%);
  --color-fuchsia-700: hsl(344, 97%, 44%);
  --color-fuchsia-800: hsl(344, 97%, 34%);
  --color-fuchsia-900: hsl(344, 97%, 20%);

  --color-petrol-100: hsl(157, 30%, 95%);
  --color-petrol-200: hsl(157, 30%, 90%);
  --color-petrol-300: hsl(157, 30%, 80%);
  --color-petrol-400: hsl(157, 30%, 70%);
  --color-petrol-500: hsl(157, 30%, 63%);
  --color-petrol-600: hsl(157, 30%, 53%);
  --color-petrol-700: hsl(157, 30%, 40%);
  --color-petrol-800: hsl(157, 30%, 30%);
  --color-petrol-900: hsl(157, 30%, 20%);

  --color-blue-100: hsla(209, 58%, 95%);
  --color-blue-200: hsla(209, 58%, 80%);
  --color-blue-300: hsla(209, 58%, 70%);
  --color-blue-400: hsla(209, 58%, 60%);
  --color-blue-500: hsla(209, 58%, 50%);
  --color-blue-600: hsla(209, 58%, 46%);
  --color-blue-700: hsla(209, 58%, 36%);
  --color-blue-800: hsla(209, 58%, 30%);
  --color-blue-900: hsl(209, 59%, 20%);

  --color-amber: hsl(37, 100%, 55%);

  --color-amber-100: hsl(37, 100%, 95%);
  --color-amber-200: hsl(37, 100%, 80%);
  --color-amber-300: hsl(37, 100%, 70%);
  --color-amber-400: hsl(37, 100%, 60%);
  --color-amber-500: hsl(37, 100%, 55%);
  --color-amber-600: hsl(37, 100%, 45%);
  --color-amber-700: hsl(37, 100%, 35%);
  --color-amber-800: hsl(37, 100%, 25%);
  --color-amber-900: hsl(37, 100%, 20%);

  /* ----------------------------------------------------------------------- */

  --fg: #000;
  --bg: #fff;
  --lh: 1;
  --title-color: var(--color-fuchsia-800);
  --title-lh: 1.45;
  --title-weight: 400;
  --header-color: var(--color-petrol-800);
  --hx-color: var(--color-fuchsia-700);
  --hx-weight: 500;
  --link-color: var(--color-blue-700);
  --link-active-color: var(--color-blue-300);
  --code-color: rgba(0, 0, 0, 0.9);
}

html {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
    Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;

  -webkit-text-size-adjust: 100%;
}

a {
  background: none;
}
a:focus {
  outline: thin dotted;
}
a:active,
a:hover {
  outline: 0;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
b,
strong {
  font-weight: bold;
}
abbr {
  font-size: 0.9em;
}
abbr[title] {
  cursor: help;
  border-bottom: 1px dotted #dddddf;
  text-decoration: none;
}
dfn {
  font-style: italic;
}
hr {
  height: 0;
}
mark {
  background: #ff0;
  color: #000;
}
code,
kbd,
pre,
samp {
  font-family: monospace;
  font-size: 1em;
}
pre {
  white-space: pre-wrap;
}
q {
  quotes: "\201C""\201D""\2018""\2019";
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 0;
}
audio,
video {
  display: inline-block;
}
audio:not([controls]) {
  display: none;
  height: 0;
}
fieldset {
  border: 1px solid silver;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0;
  padding: 0;
}
button,
input,
select,
textarea {
  font-family: inherit;
  font-size: 100%;
  margin: 0;
}
button,
input {
  line-height: normal;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"],
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button;
  cursor: pointer;
}
button[disabled],
html input[disabled] {
  cursor: default;
}
input[type="checkbox"],
input[type="radio"] {
  padding: 0;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
textarea {
  overflow: auto;
  vertical-align: top;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}
*,
::before,
::after {
  box-sizing: border-box;
}
html,
body {
  font-size: 104%;
}
body {
  background: var(--bg);
  color: var(--fg);
  padding: 0;
  margin: 0;
  line-height: var(--lh);
  position: relative;
  cursor: auto;
  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;
  word-wrap: anywhere;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
}
a:hover {
  cursor: pointer;
}
img,
object,
embed {
  max-width: 100%;
  height: auto;
}
object,
embed {
  height: 100%;
}
img {
  -ms-interpolation-mode: bicubic;
}
.left {
  float: left !important;
}
.right {
  float: right !important;
}
.text-left {
  text-align: left !important;
}
.text-right {
  text-align: right !important;
}
.text-center {
  text-align: center !important;
}
.text-justify {
  text-align: justify !important;
}
.hide {
  display: none;
}
img,
object,
svg {
  display: inline-block;
  vertical-align: middle;
}
textarea {
  height: auto;
  min-height: 50px;
}
select {
  width: 100%;
}
.subheader,
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  line-height: var(--title-lh);
  color: var(--title-color);
  font-weight: var(--title-weight);
  margin-top: 0;
  margin-bottom: 0.25em;
}
div,
dl,
dt,
dd,
ul,
ol,
li,
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6,
pre,
form,
p,
blockquote,
th,
td {
  margin: 0;
  padding: 0;
}
a {
  color: var(--link-color);
  text-decoration: underline;
  line-height: inherit;
}
a:hover,
a:focus {
  color: var(--link-active-color);
}
a img {
  border: 0;
}
p {
  line-height: 1.6;
  margin-bottom: 1.25em;
  text-rendering: optimizeLegibility;
}
p aside {
  font-size: 0.875em;
  line-height: 1.35;
  font-style: italic;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-weight: var(--hx-weight);
  font-style: normal;
  color: var(--hx-color);
  text-rendering: optimizeLegibility;
  margin-top: 1em;
  margin-bottom: 0.5em;
  line-height: 1.0125em;
}
h1 small,
h2 small,
h3 small,
#toctitle small,
.sidebarblock > .content > .title small,
h4 small,
h5 small,
h6 small {
  font-size: 60%;
  color: #e99b8f;
  line-height: 0;
}
h1 {
  font-size: 2.125em;
}
h2 {
  font-size: 1.6875em;
}
h3,
#toctitle,
.sidebarblock > .content > .title {
  font-size: 1.375em;
}
h4,
h5 {
  font-size: 1.125em;
}
h6 {
  font-size: 1em;
}
hr {
  border: solid #dddddf;
  border-width: 1px 0 0;
  clear: both;
  margin: 1.25em 0 1.1875em;
}
em,
i {
  font-style: italic;
  line-height: inherit;
}
strong,
b {
  font-weight: bold;
  line-height: inherit;
}
small {
  font-size: 60%;
  line-height: inherit;
}
code {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  font-weight: 400;
  color: var(--code-color);
}
ul,
ol,
dl {
  line-height: 1.6;
  margin-bottom: 1.25em;
  list-style-position: outside;
  font-family: inherit;
}
ul,
ol {
  margin-left: 1.5em;
}
ul li ul,
ul li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
}
ul.circle {
  list-style-type: circle;
}
ul.disc {
  list-style-type: disc;
}
ul.square {
  list-style-type: square;
}
ul.circle ul:not([class]),
ul.disc ul:not([class]),
ul.square ul:not([class]) {
  list-style: inherit;
}
ol li ul,
ol li ol {
  margin-left: 1.25em;
  margin-bottom: 0;
}
dl dt {
  margin-bottom: 0.3125em;
  font-weight: bold;
}
dl dd {
  margin-bottom: 1.25em;
}
blockquote {
  margin: 0 0 1.25em;
  padding: 0.5625em 1.25em 0 1.1875em;
  border-left: 1px solid #ddd;
}
blockquote,
blockquote p {
  line-height: 1.6;
  color: rgba(0, 0, 0, 0.85);
}
@media screen and (min-width: 768px) {
  h1,
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title,
  h4,
  h5,
  h6 {
    line-height: 1.2;
  }
  h1 {
    font-size: 2.75em;
  }
  h2 {
    font-size: 2.3125em;
  }
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    font-size: 1.6875em;
  }
  h4 {
    font-size: 1.4375em;
  }
}
table {
  background: #fff;
  margin-bottom: 1.25em;
  border: 1px solid #dedede;
  word-wrap: normal;
}
table thead,
table tfoot {
  background: #f7f8f7;
}
table thead tr th,
table thead tr td,
table tfoot tr th,
table tfoot tr td {
  padding: 0.5em 0.625em 0.625em;
  font-size: inherit;
  color: var(--fg);
  text-align: left;
}
table tr th,
table tr td {
  padding: 0.5625em 0.625em;
  font-size: inherit;
  color: var(--fg);
}
table tr.even,
table tr.alt {
  background: #f8f8f7;
}
table thead tr th,
table tfoot tr th,
table tbody tr td,
table tr td,
table tfoot tr td {
  line-height: 1.6;
}
h1,
h2,
h3,
#toctitle,
.sidebarblock > .content > .title,
h4,
h5,
h6 {
  line-height: 1.2;
  word-spacing: -0.05em;
}
h1 strong,
h2 strong,
h3 strong,
#toctitle strong,
.sidebarblock > .content > .title strong,
h4 strong,
h5 strong,
h6 strong {
  font-weight: 400;
}
.center {
  margin-left: auto;
  margin-right: auto;
}
.stretch {
  width: 100%;
}
.clearfix::before,
.clearfix::after,
.float-group::before,
.float-group::after {
  content: " ";
  display: table;
}
.clearfix::after,
.float-group::after {
  clear: both;
}
:not(pre).nobreak {
  word-wrap: normal;
}
:not(pre).nowrap {
  white-space: nowrap;
}
:not(pre).pre-wrap {
  white-space: pre-wrap;
}
:not(pre):not([class^="L"]) > code {
  font-size: 0.9375em;
  font-style: normal !important;
  letter-spacing: 0;
  padding: 0.1em 0.5ex;
  word-spacing: -0.15em;
  background: #f7f7f8;
  border-radius: 4px;
  line-height: 1.45;
  text-rendering: optimizeSpeed;
}
pre {
  color: var(--code-color);
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  line-height: 1.45;
  text-rendering: optimizeSpeed;
}
pre code,
pre pre {
  color: inherit;
  font-size: inherit;
  line-height: inherit;
}
pre > code {
  display: block;
}
pre.nowrap,
pre.nowrap pre {
  white-space: pre;
  word-wrap: normal;
}
em em {
  font-style: normal;
}
strong strong {
  font-weight: 400;
}
.keyseq {
  color: rgba(51, 51, 51, 0.8);
}
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, 0.8);
  font-size: 0.65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  border-radius: 3px;
  box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), inset 0 0 0 0.1em #fff;
  margin: 0 0.15em;
  padding: 0.2em 0.5em;
  vertical-align: middle;
  position: relative;
  top: -0.1em;
  white-space: nowrap;
}
.keyseq kbd:first-child {
  margin-left: 0;
}
.keyseq kbd:last-child {
  margin-right: 0;
}
.menuseq,
.menuref {
  color: #000;
}
.menuseq b:not(.caret),
.menuref {
  font-weight: inherit;
}
.menuseq {
  word-spacing: -0.02em;
}
.menuseq b.caret {
  font-size: 1.25em;
  line-height: 0.8;
}
.menuseq i.caret {
  font-weight: bold;
  text-align: center;
  width: 0.45em;
}
b.button::before,
b.button::after {
  position: relative;
  top: -1px;
  font-weight: 400;
}
b.button::before {
  content: "[";
  padding: 0 3px 0 2px;
}
b.button::after {
  content: "]";
  padding: 0 2px 0 3px;
}
p a > code:hover {
  color: var(--code-color);
}
#header,
#content,
#footnotes,
#footer {
  width: 100%;
  margin: 0 auto;
  max-width: 62.5em;
  *zoom: 1;
  position: relative;
  padding-left: 0.9375em;
  padding-right: 0.9375em;
}
#header::before,
#header::after,
#content::before,
#content::after,
#footnotes::before,
#footnotes::after,
#footer::before,
#footer::after {
  content: " ";
  display: table;
}
#header::after,
#content::after,
#footnotes::after,
#footer::after {
  clear: both;
}
#content {
  margin-top: 1.25em;
}
#content::before {
  content: none;
}
#header > h1:first-child {
  color: var(--header-color);
  margin-top: 2.25rem;
  margin-bottom: 0;
}
#header > h1:first-child + #toc {
  margin-top: 8px;
  border-top: 1px solid #dddddf;
}
#header > h1:only-child,
body.toc2 #header > h1:nth-last-child(2) {
  border-bottom: 1px solid #dddddf;
  padding-bottom: 8px;
}
#header .details {
  border-bottom: 1px solid #dddddf;
  line-height: 1.45;
  padding-top: 0.25em;
  padding-bottom: 0.25em;
  padding-left: 0.25em;
  color: rgba(0, 0, 0, 0.6);
  display: flex;
  flex-flow: row wrap;
}
#header .details span:first-child {
  margin-left: -0.125em;
}
#header .details span.email a {
  color: rgba(0, 0, 0, 0.85);
}
#header .details br {
  display: none;
}
#header .details br + span::before {
  content: "\00a0\2013\00a0";
}
#header .details br + span.author::before {
  content: "\00a0\22c5\00a0";
  color: rgba(0, 0, 0, 0.85);
}
#header .details br + span#revremark::before {
  content: "\00a0|\00a0";
}
#header #revnumber {
  text-transform: capitalize;
}
#header #revnumber::after {
  content: "\00a0";
}
#content > h1:first-child:not([class]) {
  color: rgba(0, 0, 0, 0.85);
  border-bottom: 1px solid #dddddf;
  padding-bottom: 8px;
  margin-top: 0;
  padding-top: 1rem;
  margin-bottom: 1.25rem;
}
#toc {
  border-bottom: 1px solid #e7e7e9;
  padding-bottom: 0.5em;
}
#toc > ul {
  margin-left: 0.125em;
}
#toc ul.sectlevel0 > li > a {
  font-style: italic;
}
#toc ul.sectlevel0 ul.sectlevel1 {
  margin: 0.5em 0;
}
#toc ul {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  list-style-type: none;
}
#toc li {
  line-height: 1.3334;
  margin-top: 0.3334em;
}
#toc a {
  text-decoration: none;
}
#toc a:active {
  text-decoration: underline;
}
#toctitle {
  color: var(--title-color);
  font-size: 1.2em;
}
@media screen and (min-width: 768px) {
  #toctitle {
    font-size: 1.375em;
  }
  body.toc2 {
    padding-left: 15em;
    padding-right: 0;
  }
  #toc.toc2 {
    margin-top: 0 !important;
    background: #f8f8f7;
    position: fixed;
    width: 15em;
    left: 0;
    top: 0;
    border-right: 1px solid #e7e7e9;
    border-top-width: 0 !important;
    border-bottom-width: 0 !important;
    z-index: 1000;
    padding: 1.25em 1em;
    height: 100%;
    overflow: auto;
  }
  #toc.toc2 #toctitle {
    margin-top: 0;
    margin-bottom: 0.8rem;
    font-size: 1.2em;
  }
  #toc.toc2 > ul {
    font-size: 0.9em;
    margin-bottom: 0;
  }
  #toc.toc2 ul ul {
    margin-left: 0;
    padding-left: 1em;
  }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
    padding-left: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 15em;
  }
  body.toc2.toc-right #toc.toc2 {
    border-right-width: 0;
    border-left: 1px solid #e7e7e9;
    left: auto;
    right: 0;
  }
}
@media screen and (min-width: 1280px) {
  body.toc2 {
    padding-left: 20em;
    padding-right: 0;
  }
  #toc.toc2 {
    width: 20em;
  }
  #toc.toc2 #toctitle {
    font-size: 1.375em;
  }
  #toc.toc2 > ul {
    font-size: 0.95em;
  }
  #toc.toc2 ul ul {
    padding-left: 1.25em;
  }
  body.toc2.toc-right {
    padding-left: 0;
    padding-right: 20em;
  }
}
#content #toc {
  border: 1px solid #e0e0dc;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f8f8f7;
  border-radius: 4px;
}
#content #toc > :first-child {
  margin-top: 0;
}
#content #toc > :last-child {
  margin-bottom: 0;
}
#footer {
  max-width: none;
  background: rgba(0, 0, 0, 0.8);
  padding: 1.25em;
}
#footer-text {
  color: hsla(0, 0%, 100%, 0.8);
  line-height: 1.44;
}
#content {
  margin-bottom: 0.625em;
}
.sect1 {
  padding-bottom: 0.625em;
}
@media screen and (min-width: 768px) {
  #content {
    margin-bottom: 1.25em;
    padding-left: 3em;
    padding-right: 5em;
  }
  .sect1 {
    padding-bottom: 1.25em;
  }
}
.sect1:last-child {
  padding-bottom: 0;
}
.sect1 + .sect1 {
  border-top: 1px solid #e7e7e9;
}
#content h1 > a.anchor,
h2 > a.anchor,
h3 > a.anchor,
#toctitle > a.anchor,
.sidebarblock > .content > .title > a.anchor,
h4 > a.anchor,
h5 > a.anchor,
h6 > a.anchor {
  position: absolute;
  z-index: 1001;
  width: 1.5ex;
  margin-left: -1.5ex;
  display: block;
  text-decoration: none !important;
  visibility: hidden;
  text-align: center;
  font-weight: 400;
}
#content h1 > a.anchor::before,
h2 > a.anchor::before,
h3 > a.anchor::before,
#toctitle > a.anchor::before,
.sidebarblock > .content > .title > a.anchor::before,
h4 > a.anchor::before,
h5 > a.anchor::before,
h6 > a.anchor::before {
  content: "\00A7";
  font-size: 0.85em;
  display: block;
  padding-top: 0.1em;
}
#content h1:hover > a.anchor,
#content h1 > a.anchor:hover,
h2:hover > a.anchor,
h2 > a.anchor:hover,
h3:hover > a.anchor,
#toctitle:hover > a.anchor,
.sidebarblock > .content > .title:hover > a.anchor,
h3 > a.anchor:hover,
#toctitle > a.anchor:hover,
.sidebarblock > .content > .title > a.anchor:hover,
h4:hover > a.anchor,
h4 > a.anchor:hover,
h5:hover > a.anchor,
h5 > a.anchor:hover,
h6:hover > a.anchor,
h6 > a.anchor:hover {
  visibility: visible;
}
#content h1 > a.link,
h2 > a.link,
h3 > a.link,
#toctitle > a.link,
.sidebarblock > .content > .title > a.link,
h4 > a.link,
h5 > a.link,
h6 > a.link {
  color: var(--hx-color);
  text-decoration: none;
}
#content h1 > a.link:hover,
h2 > a.link:hover,
h3 > a.link:hover,
#toctitle > a.link:hover,
.sidebarblock > .content > .title > a.link:hover,
h4 > a.link:hover,
h5 > a.link:hover,
h6 > a.link:hover {
  color: #a53221;
}
details,
.audioblock,
.imageblock,
.literalblock,
.listingblock,
.stemblock,
.videoblock {
  margin-bottom: 1.25em;
}
details {
  margin-left: 1.25rem;
}
details > summary {
  cursor: pointer;
  display: block;
  position: relative;
  line-height: 1.6;
  margin-bottom: 0.625rem;
  outline: none;
  -webkit-tap-highlight-color: transparent;
}
details > summary::-webkit-details-marker {
  display: none;
}
details > summary::before {
  content: "";
  border: solid transparent;
  border-left: solid;
  border-width: 0.3em 0 0.3em 0.5em;
  position: absolute;
  top: 0.5em;
  left: -1.25rem;
  transform: translateX(15%);
}
details[open] > summary::before {
  border: solid transparent;
  border-top: solid;
  border-width: 0.5em 0.3em 0;
  transform: translateY(15%);
}
details > summary::after {
  content: "";
  width: 1.25rem;
  height: 1em;
  position: absolute;
  top: 0.3em;
  left: -1.25rem;
}
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
  text-rendering: optimizeLegibility;
  text-align: left;
  font-family: "Noto Serif", "DejaVu Serif", serif;
  font-size: 1rem;
  font-style: italic;
}
table.tableblock.fit-content > caption.title {
  white-space: nowrap;
  width: 0;
}
.paragraph.lead > p,
#preamble > .sectionbody > [class="paragraph"]:first-of-type p {
  font-size: 1.21875em;
  line-height: 1.6;
  color: rgba(0, 0, 0, 0.85);
}
.admonitionblock > table {
  border-collapse: separate;
  border: 0;
  background: none;
  width: 100%;
}
.admonitionblock > table td.icon {
  text-align: center;
  width: 80px;
}
.admonitionblock > table td.icon img {
  max-width: none;
}
.admonitionblock > table td.icon .title {
  font-weight: bold;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  text-transform: uppercase;
}
.admonitionblock > table td.content {
  padding-left: 1.125em;
  padding-right: 1.25em;
  border-left: 1px solid #dddddf;
  color: rgba(0, 0, 0, 0.6);
  word-wrap: anywhere;
}
.admonitionblock > table td.content > :last-child > :last-child {
  margin-bottom: 0;
}
.exampleblock > .content {
  border: 1px solid #e6e6e6;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #fff;
  border-radius: 4px;
}
.exampleblock > .content > :first-child {
  margin-top: 0;
}
.exampleblock > .content > :last-child {
  margin-bottom: 0;
}
.sidebarblock {
  border: 1px solid #dbdbd6;
  margin-bottom: 1.25em;
  padding: 1.25em;
  background: #f3f3f2;
  border-radius: 4px;
}
.sidebarblock > :first-child {
  margin-top: 0;
}
.sidebarblock > :last-child {
  margin-bottom: 0;
}
.sidebarblock > .content > .title {
  color: var(--title-color);
  margin-top: 0;
  text-align: center;
}
.exampleblock > .content > :last-child > :last-child,
.exampleblock > .content .olist > ol > li:last-child > :last-child,
.exampleblock > .content .ulist > ul > li:last-child > :last-child,
.exampleblock > .content .qlist > ol > li:last-child > :last-child,
.sidebarblock > .content > :last-child > :last-child,
.sidebarblock > .content .olist > ol > li:last-child > :last-child,
.sidebarblock > .content .ulist > ul > li:last-child > :last-child,
.sidebarblock > .content .qlist > ol > li:last-child > :last-child {
  margin-bottom: 0;
}
.literalblock pre,
.listingblock > .content > pre {
  border-radius: 4px;
  overflow-x: auto;
  padding: 1em;
  font-size: 0.8125em;
}
@media screen and (min-width: 768px) {
  .literalblock pre,
  .listingblock > .content > pre {
    font-size: 0.90625em;
  }
}
@media screen and (min-width: 1280px) {
  .literalblock pre,
  .listingblock > .content > pre {
    font-size: 1em;
  }
}
.literalblock pre,
.listingblock > .content > pre:not(.highlight),
.listingblock > .content > pre[class="highlight"],
.listingblock > .content > pre[class^="highlight "] {
  background: #f7f7f8;
}
.literalblock.output pre {
  color: #f7f7f8;
  background: rgba(0, 0, 0, 0.9);
}
.listingblock > .content {
  position: relative;
}
.listingblock code[data-lang]::before {
  display: none;
  content: attr(data-lang);
  position: absolute;
  font-size: 0.75em;
  top: 0.425rem;
  right: 0.5rem;
  line-height: 1;
  text-transform: uppercase;
  color: inherit;
  opacity: 0.5;
}
.listingblock:hover code[data-lang]::before {
  display: block;
}
.listingblock.terminal pre .command::before {
  content: attr(data-prompt);
  padding-right: 0.5em;
  color: inherit;
  opacity: 0.5;
}
.listingblock.terminal pre .command:not([data-prompt])::before {
  content: "$";
}
.listingblock pre.highlightjs {
  padding: 0;
}
.listingblock pre.highlightjs > code {
  padding: 1em;
  border-radius: 4px;
}
.listingblock pre.prettyprint {
  border-width: 0;
}
.prettyprint {
  background: #f7f7f8;
}
pre.prettyprint .linenums {
  line-height: 1.45;
  margin-left: 2em;
}
pre.prettyprint li {
  background: none;
  list-style-type: inherit;
  padding-left: 0;
}
pre.prettyprint li code[data-lang]::before {
  opacity: 1;
}
pre.prettyprint li:not(:first-child) code[data-lang]::before {
  display: none;
}
table.linenotable {
  border-collapse: separate;
  border: 0;
  margin-bottom: 0;
  background: none;
}
table.linenotable td[class] {
  color: inherit;
  vertical-align: top;
  padding: 0;
  line-height: inherit;
  white-space: normal;
}
table.linenotable td.code {
  padding-left: 0.75em;
}
table.linenotable td.linenos,
pre.pygments .linenos {
  border-right: 1px solid;
  opacity: 0.35;
  padding-right: 0.5em;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
pre.pygments span.linenos {
  display: inline-block;
  margin-right: 0.75em;
}
.quoteblock {
  margin: 0 1em 1.25em 1.5em;
  display: table;
}
.quoteblock:not(.excerpt) > .title {
  margin-left: -1.5em;
  margin-bottom: 0.75em;
}
.quoteblock blockquote,
.quoteblock p {
  color: rgba(0, 0, 0, 0.85);
  font-size: 1.15rem;
  line-height: 1.75;
  word-spacing: 0.1em;
  letter-spacing: 0;
  font-style: italic;
  text-align: justify;
}
.quoteblock blockquote {
  margin: 0;
  padding: 0;
  border: 0;
}
.quoteblock blockquote::before {
  content: "\201c";
  float: left;
  font-size: 2.75em;
  font-weight: bold;
  line-height: 0.6em;
  margin-left: -0.6em;
  color: var(--title-color);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}
.quoteblock blockquote > .paragraph:last-child p {
  margin-bottom: 0;
}
.quoteblock .attribution {
  margin-top: 0.75em;
  margin-right: 0.5ex;
  text-align: right;
}
.verseblock {
  margin: 0 1em 1.25em;
}
.verseblock pre {
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-size: 1.15rem;
  color: rgba(0, 0, 0, 0.85);
  font-weight: 300;
  text-rendering: optimizeLegibility;
}
.verseblock pre strong {
  font-weight: 400;
}
.verseblock .attribution {
  margin-top: 1.25rem;
  margin-left: 0.5ex;
}
.quoteblock .attribution,
.verseblock .attribution {
  font-size: 0.9375em;
  line-height: 1.45;
  font-style: italic;
}
.quoteblock .attribution br,
.verseblock .attribution br {
  display: none;
}
.quoteblock .attribution cite,
.verseblock .attribution cite {
  display: block;
  letter-spacing: -0.025em;
  color: rgba(0, 0, 0, 0.6);
}
.quoteblock.abstract blockquote::before,
.quoteblock.excerpt blockquote::before,
.quoteblock .quoteblock blockquote::before {
  display: none;
}
.quoteblock.abstract blockquote,
.quoteblock.abstract p,
.quoteblock.excerpt blockquote,
.quoteblock.excerpt p,
.quoteblock .quoteblock blockquote,
.quoteblock .quoteblock p {
  line-height: 1.6;
  word-spacing: 0;
}
.quoteblock.abstract {
  margin: 0 1em 1.25em;
  display: block;
}
.quoteblock.abstract > .title {
  margin: 0 0 0.375em;
  font-size: 1.15em;
  text-align: center;
}
.quoteblock.excerpt > blockquote,
.quoteblock .quoteblock {
  padding: 0 0 0.25em 1em;
  border-left: 0.25em solid #dddddf;
}
.quoteblock.excerpt,
.quoteblock .quoteblock {
  margin-left: 0;
}
.quoteblock.excerpt blockquote,
.quoteblock.excerpt p,
.quoteblock .quoteblock blockquote,
.quoteblock .quoteblock p {
  color: inherit;
  font-size: 1.0625rem;
}
.quoteblock.excerpt .attribution,
.quoteblock .quoteblock .attribution {
  color: inherit;
  font-size: 0.85rem;
  text-align: left;
  margin-right: 0;
}
p.tableblock:last-child {
  margin-bottom: 0;
}
td.tableblock > .content {
  margin-bottom: 1.25em;
  word-wrap: anywhere;
}
td.tableblock > .content > :last-child {
  margin-bottom: -1.25em;
}
table.tableblock,
th.tableblock,
td.tableblock {
  border: 0 solid #dedede;
}
table.grid-all > * > tr > * {
  border-width: 1px;
}
table.grid-cols > * > tr > * {
  border-width: 0 1px;
}
table.grid-rows > * > tr > * {
  border-width: 1px 0;
}
table.frame-all {
  border-width: 1px;
}
table.frame-ends {
  border-width: 1px 0;
}
table.frame-sides {
  border-width: 0 1px;
}
table.frame-none > colgroup + * > :first-child > *,
table.frame-sides > colgroup + * > :first-child > * {
  border-top-width: 0;
}
table.frame-none > :last-child > :last-child > *,
table.frame-sides > :last-child > :last-child > * {
  border-bottom-width: 0;
}
table.frame-none > * > tr > :first-child,
table.frame-ends > * > tr > :first-child {
  border-left-width: 0;
}
table.frame-none > * > tr > :last-child,
table.frame-ends > * > tr > :last-child {
  border-right-width: 0;
}
table.stripes-all > * > tr,
table.stripes-odd > * > tr:nth-of-type(odd),
table.stripes-even > * > tr:nth-of-type(even),
table.stripes-hover > * > tr:hover {
  background: #f8f8f7;
}
th.halign-left,
td.halign-left {
  text-align: left;
}
th.halign-right,
td.halign-right {
  text-align: right;
}
th.halign-center,
td.halign-center {
  text-align: center;
}
th.valign-top,
td.valign-top {
  vertical-align: top;
}
th.valign-bottom,
td.valign-bottom {
  vertical-align: bottom;
}
th.valign-middle,
td.valign-middle {
  vertical-align: middle;
}
table thead th,
table tfoot th {
  font-weight: bold;
}
tbody tr th {
  background: #f7f8f7;
}
tbody tr th,
tbody tr th p,
tfoot tr th,
tfoot tr th p {
  color: rgba(0, 0, 0, 0.8);
  font-weight: bold;
}
p.tableblock > code:only-child {
  background: none;
  padding: 0;
}
p.tableblock {
  font-size: 1em;
}
ol {
  margin-left: 1.75em;
}
ul li ol {
  margin-left: 1.5em;
}
dl dd {
  margin-left: 1.125em;
}
dl dd:last-child,
dl dd:last-child > :last-child {
  margin-bottom: 0;
}
li p,
ul dd,
ol dd,
.olist .olist,
.ulist .ulist,
.ulist .olist,
.olist .ulist {
  margin-bottom: 0.625em;
}
ul.checklist,
ul.none,
ol.none,
ul.no-bullet,
ol.no-bullet,
ol.unnumbered,
ul.unstyled,
ol.unstyled {
  list-style-type: none;
}
ul.no-bullet,
ol.no-bullet,
ol.unnumbered {
  margin-left: 0.625em;
}
ul.unstyled,
ol.unstyled {
  margin-left: 0;
}
li > p:empty:only-child::before {
  content: "";
  display: inline-block;
}
ul.checklist > li > p:first-child {
  margin-left: -1em;
}
ul.checklist > li > p:first-child > .fa-square-o:first-child,
ul.checklist > li > p:first-child > .fa-check-square-o:first-child {
  width: 1.25em;
  font-size: 0.8em;
  position: relative;
  bottom: 0.125em;
}
ul.checklist > li > p:first-child > input[type="checkbox"]:first-child {
  margin-right: 0.25em;
}
ul.inline {
  display: flex;
  flex-flow: row wrap;
  list-style: none;
  margin: 0 0 0.625em -1.25em;
}
ul.inline > li {
  margin-left: 1.25em;
}
.unstyled dl dt {
  font-weight: 400;
  font-style: normal;
}
ol.arabic {
  list-style-type: decimal;
}
ol.decimal {
  list-style-type: decimal-leading-zero;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}
ol.lowergreek {
  list-style-type: lower-greek;
}
.hdlist > table,
.colist > table {
  border: 0;
  background: none;
}
.hdlist > table > tbody > tr,
.colist > table > tbody > tr {
  background: none;
}
td.hdlist1,
td.hdlist2 {
  vertical-align: top;
  padding: 0 0.625em;
}
td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em;
}
td.hdlist2 {
  word-wrap: anywhere;
}
.literalblock + .colist,
.listingblock + .colist {
  margin-top: -0.5em;
}
.colist td:not([class]):first-child {
  padding: 0.4em 0.75em 0;
  line-height: 1;
  vertical-align: top;
}
.colist td:not([class]):first-child img {
  max-width: none;
}
.colist td:not([class]):last-child {
  padding: 0.25em 0;
}
.thumb,
.th {
  line-height: 0;
  display: inline-block;
  border: 4px solid #fff;
  box-shadow: 0 0 0 1px #ddd;
}
.imageblock.left {
  margin: 0.25em 0.625em 1.25em 0;
}
.imageblock.right {
  margin: 0.25em 0 1.25em 0.625em;
}
.imageblock > .title {
  margin-bottom: 0;
}
.imageblock.thumb,
.imageblock.th {
  border-width: 6px;
}
.imageblock.thumb > .title,
.imageblock.th > .title {
  padding: 0 0.125em;
}
.image.left,
.image.right {
  margin-top: 0.25em;
  margin-bottom: 0.25em;
  display: inline-block;
  line-height: 0;
}
.image.left {
  margin-right: 0.625em;
}
.image.right {
  margin-left: 0.625em;
}
a.image {
  text-decoration: none;
  display: inline-block;
}
a.image object {
  pointer-events: none;
}
sup.footnote,
sup.footnoteref {
  font-size: 0.875em;
  position: static;
  vertical-align: super;
}
sup.footnote a,
sup.footnoteref a {
  text-decoration: none;
}
sup.footnote a:active,
sup.footnoteref a:active {
  text-decoration: underline;
}
#footnotes {
  padding-top: 0.75em;
  padding-bottom: 0.75em;
  margin-bottom: 0.625em;
}
#footnotes hr {
  width: 20%;
  min-width: 6.25em;
  margin: -0.25em 0 0.75em;
  border-width: 1px 0 0;
}
#footnotes .footnote {
  padding: 0 0.375em 0 0.225em;
  line-height: 1.3334;
  font-size: 0.875em;
  margin-left: 1.2em;
  margin-bottom: 0.2em;
}
#footnotes .footnote a:first-of-type {
  font-weight: bold;
  text-decoration: none;
  margin-left: -1.05em;
}
#footnotes .footnote:last-of-type {
  margin-bottom: 0;
}
#content #footnotes {
  margin-top: -0.625em;
  margin-bottom: 0;
  padding: 0.75em 0;
}
div.unbreakable {
  page-break-inside: avoid;
}
.big {
  font-size: larger;
}
.small {
  font-size: smaller;
}
.underline {
  text-decoration: underline;
}
.overline {
  text-decoration: overline;
}
.line-through {
  text-decoration: line-through;
}
.aqua {
  color: #00bfbf;
}
.aqua-background {
  background: #00fafa;
}
.black {
  color: #000;
}
.black-background {
  background: #000;
}
.blue {
  color: #0000bf;
}
.blue-background {
  background: #0000fa;
}
.fuchsia {
  color: #bf00bf;
}
.fuchsia-background {
  background: #fa00fa;
}
.gray {
  color: #606060;
}
.gray-background {
  background: #7d7d7d;
}
.green {
  color: #006000;
}
.green-background {
  background: #007d00;
}
.lime {
  color: #00bf00;
}
.lime-background {
  background: #00fa00;
}
.maroon {
  color: #600000;
}
.maroon-background {
  background: #7d0000;
}
.navy {
  color: #000060;
}
.navy-background {
  background: #00007d;
}
.olive {
  color: #606000;
}
.olive-background {
  background: #7d7d00;
}
.purple {
  color: #600060;
}
.purple-background {
  background: #7d007d;
}
.red {
  color: #bf0000;
}
.red-background {
  background: #fa0000;
}
.silver {
  color: #909090;
}
.silver-background {
  background: #bcbcbc;
}
.teal {
  color: #006060;
}
.teal-background {
  background: #007d7d;
}
.white {
  color: #bfbfbf;
}
.white-background {
  background: #fafafa;
}
.yellow {
  color: #bfbf00;
}
.yellow-background {
  background: #fafa00;
}
span.icon > .fa {
  cursor: default;
}
a span.icon > .fa {
  cursor: inherit;
}
.admonitionblock td.icon [class^="fa icon-"] {
  font-size: 2.5em;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
  cursor: default;
}
.admonitionblock td.icon .icon-note::before {
  content: "\f05a";
  color: #19407c;
}
.admonitionblock td.icon .icon-tip::before {
  content: "\f0eb";
  text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
  color: #111;
}
.admonitionblock td.icon .icon-warning::before {
  content: "\f071";
  color: #bf6900;
}
.admonitionblock td.icon .icon-caution::before {
  content: "\f06d";
  color: #bf3400;
}
.admonitionblock td.icon .icon-important::before {
  content: "\f06a";
  color: #bf0000;
}
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, 0.8);
  border-radius: 50%;
  text-align: center;
  font-size: 0.75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold;
}
.conum[data-value] * {
  color: #fff !important;
}
.conum[data-value] + b {
  display: none;
}
.conum[data-value]::after {
  content: attr(data-value);
}
pre .conum[data-value] {
  position: relative;
  top: -0.125em;
}
b.conum * {
  color: inherit !important;
}
.conum:not([data-value]):empty {
  display: none;
}
dt,
th.tableblock,
td.content,
div.footnote {
  text-rendering: optimizeLegibility;
}
h1,
h2,
p,
td.content,
span.alt,
summary {
  letter-spacing: -0.01em;
}
p strong,
td.content strong,
div.footnote strong {
  letter-spacing: -0.005em;
}
p,
blockquote,
dt,
td.content,
span.alt,
summary {
  font-size: 1.0625rem;
}
p {
  margin-bottom: 1.25rem;
}
.sidebarblock p,
.sidebarblock dt,
.sidebarblock td.content,
p.tableblock {
  font-size: 1em;
}
.exampleblock > .content {
  background: #fffef7;
  border-color: #e0e0dc;
  box-shadow: 0 1px 4px #e0e0dc;
}
.print-only {
  display: none !important;
}
@page {
  margin: 1.25cm 0.75cm;
}
@media print {
  * {
    box-shadow: none !important;
    text-shadow: none !important;
  }
  html {
    font-size: 80%;
  }
  a {
    color: inherit !important;
    text-decoration: underline !important;
  }
  a.bare,
  a[href^="#"],
  a[href^="mailto:"] {
    text-decoration: none !important;
  }
  a[href^="http:"]:not(.bare)::after,
  a[href^="https:"]:not(.bare)::after {
    content: "(" attr(href) ")";
    display: inline-block;
    font-size: 0.875em;
    padding-left: 0.25em;
  }
  abbr[title] {
    border-bottom: 1px dotted;
  }
  abbr[title]::after {
    content: " (" attr(title) ")";
  }
  pre,
  blockquote,
  tr,
  img,
  object,
  svg {
    page-break-inside: avoid;
  }
  thead {
    display: table-header-group;
  }
  svg {
    max-width: 100%;
  }
  p,
  blockquote,
  dt,
  td.content {
    font-size: 1em;
    orphans: 3;
    widows: 3;
  }
  h2,
  h3,
  #toctitle,
  .sidebarblock > .content > .title {
    page-break-after: avoid;
  }
  #header,
  #content,
  #footnotes,
  #footer {
    max-width: none;
  }
  #toc,
  .sidebarblock,
  .exampleblock > .content {
    background: none !important;
  }
  #toc {
    border-bottom: 1px solid #dddddf !important;
    padding-bottom: 0 !important;
  }
  body.book #header {
    text-align: center;
  }
  body.book #header > h1:first-child {
    border: 0 !important;
    margin: 2.5em 0 1em;
  }
  body.book #header .details {
    border: 0 !important;
    display: block;
    padding: 0 !important;
  }
  body.book #header .details span:first-child {
    margin-left: 0 !important;
  }
  body.book #header .details br {
    display: block;
  }
  body.book #header .details br + span::before {
    content: none !important;
  }
  body.book #toc {
    border: 0 !important;
    text-align: left !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  body.book #toc,
  body.book #preamble,
  body.book h1.sect0,
  body.book .sect1 > h2 {
    page-break-before: always;
  }
  .listingblock code[data-lang]::before {
    display: block;
  }
  #footer {
    padding: 0 0.9375em;
  }
  .hide-on-print {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
  .hide-for-print {
    display: none !important;
  }
  .show-for-print {
    display: inherit !important;
  }
}
@media amzn-kf8, print {
  #header > h1:first-child {
    margin-top: 1.25rem;
  }
  .sect1 {
    padding: 0 !important;
  }
  .sect1 + .sect1 {
    border: 0;
  }
  #footer {
    background: none;
  }
  #footer-text {
    color: rgba(0, 0, 0, 0.6);
    font-size: 0.9em;
  }
}
@media amzn-kf8 {
  #header,
  #content,
  #footnotes,
  #footer {
    padding: 0;
  }
}
body {
  background-color: hsl(99, 33%, 99%);
}

</style>
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Query/Response for Spring® AMQP</h1>
<div class="details">
<span id="author" class="author">Olle Törnström</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#foreword">1. Foreword</a></li>
<li><a href="#about-this-document">2. About This Document</a></li>
<li><a href="#getting-started">3. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#system-requirements">3.1. System Requirements</a></li>
<li><a href="#installation-configuration">3.2. Installation &amp; Configuration</a></li>
<li><a href="#queries">3.3. Queries</a></li>
<li><a href="#responses">3.4. Responses</a></li>
</ul>
</li>
<li><a href="#developers-reference">4. Developers Reference</a>
<ul class="sectlevel2">
<li><a href="#overview">4.1. Overview</a></li>
<li><a href="#querybuilder">4.2. <code>QueryBuilder</code></a></li>
<li><a href="#responsebuilder">4.3. <code>ResponseBuilder</code></a></li>
</ul>
</li>
<li><a href="#monitoring-ui">5. Monitoring UI</a>
<ul class="sectlevel2">
<li><a href="#overview-2">5.1. Overview</a></li>
</ul>
</li>
<li><a href="#the-queryresponse-protocol">6. The Query/Response Protocol</a>
<ul class="sectlevel2">
<li><a href="#a-simple-example">6.1. A simple example</a></li>
<li><a href="#specification">6.2. Specification</a></li>
<li><a href="#the-example-revisited">6.3. The example revisited</a></li>
<li><a href="#queryresponse-maturity-model">6.4. Query/Response Maturity Model</a></li>
</ul>
</li>
<li><a href="#appendicies">7. Appendicies</a>
<ul class="sectlevel2">
<li><a href="#java-api">7.1. Java API</a></li>
<li><a href="#amqp-resources-formats">7.2. AMQP Resources &amp; Formats</a></li>
<li><a href="#trademarks">7.3. Trademarks</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="foreword"><a class="anchor" href="#foreword"></a>1. Foreword</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p><em>Sometime around 2015 I came across a presentation with <a href="https://twitter.com/fgeorge52">Fred George</a>,
 about the <a href="https://youtu.be/yPf5MfOZPY0">Challenges in Implementing Microservices</a>. It&#8217;s a great
 talk, with lots of good and relevant information. Experience comes from
 learning through failures, and at this point in time I had just learned a hard
 lesson about the problems with distributed services and blocking API calls. I
 had seen how latencies would go up and availability go down the drain, as
 calls from service A to B were actually depending on service B calling service
 C, calling service D. It was a mess.</em></p>
</div>
<div class="paragraph lead">
<p><em>In his talk <a href="https://twitter.com/fgeorge52">George</a> lands at the question "Synchronous or Asynchronous?"
 and proceeds to describe, what he calls, the "Needs Pattern". Service A would,
 instead of calling service B, publish a <strong>query</strong>, and service B would listen
 for it and send back a <strong>response</strong>. After hearing this I began to think a lot
 about the effects of moving to asynchronous communication between services.
 There was clearly a lot more there than just decoupling. Something more
 fundamental.</em></p>
</div>
<div class="paragraph lead">
<p><em>The <strong>Query/Response</strong> pattern, that I arrived at, challenges developers to
 really think hard about the responsibilities and autonomy of services. It
 provides very few guarantees, which will force decisions around resilience
 and availability at a much earlier stage in the design and development process.
 It literally turns things around - an inversion of responsibility - which I
 truly believe we can benefit from.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-this-document"><a class="anchor" href="#about-this-document"></a>2. About This Document</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is intended to work as a comprehensive reference for developers.
It provides an introduction to the technical prerequisites, and how to get
started. There is a deep-dive into the <code>QueryBuilder</code> and <code>ResponseBuilder</code>,
which is aimed at describing their capabilities. We present the Monitoring UI
and describe its features and benefits.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Towards the end of this document we&#8217;ve added an introduction and
     explanation of <a href="#the-queryresponse-protocol">The Query/Response Protocol</a>. For readers new to
     Query/Response we advice to go ahead and read that first.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>3. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Query/Response for Spring AMQP makes it really easy to extend Spring Boot stand-alone,
production-grade applications, that are using Spring AMQP. We have taken
a working pattern for building highly decoupled evolving service architectures,
and wrapped it in a developer friendly library.</p>
</div>
<div class="sect2">
<h3 id="system-requirements"><a class="anchor" href="#system-requirements"></a>3.1. System Requirements</h3>
<div class="paragraph">
<p>Query/Response for Spring AMQP 0.0.0-SNAPSHOT requires at least <strong>Spring Boot 2.x</strong> and
<strong>Java 11</strong>, and should work for later releases too. We are
building and running it successfully with <strong>Java 17</strong> and
the <strong>Spring Boot 3.0.3</strong> version.</p>
</div>
</div>
<div class="sect2">
<h3 id="installation-configuration"><a class="anchor" href="#installation-configuration"></a>3.2. Installation &amp; Configuration</h3>
<div class="paragraph">
<p>It is distributed as a <a href="https://maven.apache.org">Maven</a> dependency, and is known to work well with
Maven 3.3+. Using the dependency with <a href="https://gradle.org">Gradle</a> should work too. Please
see the <a href="https://github.com/olle/query-response-spring-amqp#quickstart">Quickstart</a> information, available on the project
<a href="https://github.com/olle/query-response-spring-amqp">Github page</a>, for information on how to get the Maven dependency.</p>
</div>
<div class="paragraph">
<p>Enabling Query/Response for Spring AMQP is done by loading the <code>QueryResponseConfiguration</code>
class. The most simple way to do this, is by annotating your Spring Boot
application with the <code>@EnableQueryResponse</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SpringBootApplication</span>
<span class="annotation">@EnableQueryResponse</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyApp</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {

        SpringApplication.run(MyApp.class, args);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This annotation will do nothing more but to import the
      <code>QueryResponseConfiguration</code> class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s it! There is no more infrastructure code, wiring or setup that needs to
be done. <strong>It&#8217;s just that easy.</strong></p>
</div>
<div class="sect3">
<h4 id="connecting-to-an-amqp-broker"><a class="anchor" href="#connecting-to-an-amqp-broker"></a>3.2.1. Connecting to an AMQP broker</h4>
<div class="paragraph">
<p>Before you can run your application you need to make sure there is an AMQP
broker available. By default Spring AMQP tries to connect to a
<a href="https://www.rabbitmq.com">RabbitMQ</a>, running locally on port <code>5672</code>.</p>
</div>
<div class="paragraph">
<p>Start an and run RabbitMQ using <code>docker</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ docker run -p 5672:5672 -p 15672:15672 rabbitmq:3-management</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>3-management</code> tag will enable the RabbitMQ Management UI. When the
      broker is running, it can be accessed at <a href="http://localhost:15672" class="bare">localhost:15672</a> with
      username and password <code>guest</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now running your application, will enable Query/Response for Spring AMQP, connect to the broker and
create all the resources necessary on the broker.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mvn spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p>Now is a good time to use the RabbitMQ Management UI, available at
<a href="http://localhost:15672" class="bare">localhost:15672</a>, to inspect the exchange, queues and bindings created
by Query/Response for Spring AMQP by default.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="queries"><a class="anchor" href="#queries"></a>3.3. Queries</h3>
<div class="paragraph">
<p>Publishing <strong>queries</strong> is a way for your application to ask for information that
it may need in order to accomplish tasks. Queries express a <em>need</em>, and are not
addressed to any specific service or component.</p>
</div>
<div class="paragraph">
<p>Query/Response for Spring AMQP makes it really really easy, to create and publish a query using
the <code>QueryBuilder</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Queries</span> {

    <span class="annotation">@Autowired</span>
    QueryBuilder queryBuilder;

    <span class="annotation">@Order</span>(<span class="integer">2</span>)
    <span class="annotation">@EventListener</span>(ApplicationReadyEvent.class)
    <span class="directive">public</span> <span class="type">void</span> query() {

        <span class="predefined-type">Collection</span>&lt;<span class="predefined-type">String</span>&gt; polos =
            queryBuilder.queryFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">marco</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class) // <b class="conum">(1)</b>
            .waitingFor(<span class="integer">1000L</span>) // <b class="conum">(2)</b>
            .orEmpty(); // <b class="conum">(3)</b>

        polos.stream().map(<span class="string"><span class="delimiter">&quot;</span><span class="content">marco? </span><span class="delimiter">&quot;</span></span>::concat).forEach(<span class="predefined-type">System</span>.out::println);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initiates a query for the term <code>marco</code>, with any results being consumed as,
or <em>mapped</em> to, the type <code>String.class</code>. Returned results are always
gathered in a collection. Either <strong>none, one or many</strong> elements may be
returned.</p>
</li>
<li>
<p>Queries require a timeout, here we set it to <code>1000L</code> milliseconds. This
means that this specific query will <strong>always</strong> block for 1 second.</p>
</li>
<li>
<p>The query may not receive any responses, so it <em>always</em> needs to specify
how that case should be handled. Default here is an empty collection, of
the declared return type <code>String.class</code>.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Hopefully this shows, how concise and powerful the <code>QueryBuilder</code> is, dealing
with results mapping, fault tolerance and default values in just a couple of
lines of code.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you run the application now, it will publish a <strong>query</strong> to the message
broker, which we can see in the logs.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mvn spring-boot:run
  ...
c.s.queryresponse.RabbitFacade           : |&lt;-- Published query: marco - (Body:'{}' MessageProperties [headers={x-qr-published=1589642002076}, replyTo=94f0fff4-c4f3-4491-831d-00809edb6f95, contentType=application/json, contentLength=2, deliveryMode=NON_PERSISTENT, priority=0, deliveryTag=0])</pre>
</div>
</div>
<div class="paragraph">
<p>At the moment there are no responses to be consumed, so after blocking for 1
second, nothing is printed <code>STDOUT</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="responses"><a class="anchor" href="#responses"></a>3.4. Responses</h3>
<div class="paragraph">
<p>Building services, medium, large or <em>micro</em> (who cares), that publish
<strong>responses</strong> to queries is also really easy with Query/Response for Spring AMQP, using the
<code>ResponseBuilder</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Responses</span> {

    <span class="annotation">@Autowired</span>
    ResponseBuilder responseBuilder;

    <span class="annotation">@Order</span>(<span class="integer">1</span>)
    <span class="annotation">@EventListener</span>(ApplicationReadyEvent.class)
    <span class="directive">public</span> <span class="type">void</span> response() {

        responseBuilder.respondTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">marco</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class) // <b class="conum">(1)</b>
        .withAll() // <b class="conum">(2)</b>
        .from(<span class="string"><span class="delimiter">&quot;</span><span class="content">polo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">yolo</span><span class="delimiter">&quot;</span></span>); // <b class="conum">(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initializes a response to queries for <code>marco</code>, providing the type-hint on
how to map entries in the response. Set to <code>String.class</code> here.</p>
</li>
<li>
<p>The response <code>withAll()</code> will publish all elements in one single response.</p>
</li>
<li>
<p>And finally this response is provided the elements <code>"polo", "yolo"</code> as the
actual data to publish. <em>The builder varags method, used here, is mostly
for trying out Query/Response for Spring AMQP, or for static responses.</em></p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Again, the builder makes it really easy to create a responding service, without
any special setup or complicated configurations.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now if you run the application again, with the response component registered
before the query publisher, it will publish the response.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mvn spring-boot:run
  ...
c.s.queryresponse.RabbitFacade           : |&lt;-- Published query: marco - (Body:'{}' MessageProperties [headers={x-qr-published=1589642489894}, replyTo=c77a8a1d-c959-4f2a-bd51-85b7e6b5b69b, contentType=application/json, contentLength=2, deliveryMode=NON_PERSISTENT, priority=0, deliveryTag=0])
c.s.queryresponse.Response               : |--&gt; Consumed query: marco
c.s.queryresponse.RabbitFacade           : |&lt;-- Published response: c77a8a1d-c959-4f2a-bd51-85b7e6b5b69b - (Body:'{"elements":["polo","yolo"]}' MessageProperties [headers={x-qr-published=1589642489941}, contentType=application/json, contentEncoding=UTF-8, contentLength=28, deliveryMode=NON_PERSISTENT, priority=0, deliveryTag=0])
c.s.queryresponse.Query                  : |--&gt; Received response message: MessageProperties [headers={x-qr-published=1589642489941}, contentType=application/json, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=NON_PERSISTENT, priority=0, redelivered=false, receivedExchange=, receivedRoutingKey=c77a8a1d-c959-4f2a-bd51-85b7e6b5b69b, deliveryTag=1, consumerTag=amq.ctag-Q_ghWp4TWU9EYhi_rqErcg, consumerQueue=c77a8a1d-c959-4f2a-bd51-85b7e6b5b69b]
marco? polo
marco? yolo</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can see a full roundtrip of the <strong>query</strong> being published and consumed,
and the <strong>response</strong> being published and also consumed. And the finished output
is "polo" and "yolo" printed on <code>STDOUT</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We are using the <code>@Order</code> annotation in our example only to ensure that
      responses are built and registered before queries, when they are built
      in one and the same app.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developers-reference"><a class="anchor" href="#developers-reference"></a>4. Developers Reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>4.1. Overview</h3>
<div class="paragraph">
<p>The goal of Query/Response for Spring AMQP is to provide developers with tools that are easy to use
and understand. We believe that a procedural and imperative style of writing
programs, or thinking about tasks in programs, is broadly understood and
valuable model. With Query/Response for Spring AMQP we try to support this, rather than introducing
any new concepts for <em>streams</em>, <em>futures</em> or <em>promises</em>.</p>
</div>
<div class="paragraph">
<p>With Query/Response for Spring AMQP developers should feel enabled to write code in a <em>normal</em> way.
However, it is our mission to raise awareness of things that are hard to
consider, when building <a href="https://en.wikipedia.org/wiki/Distributed_computing">distributed systems</a>. The tools try to convey
these considerations, by making them transparent and part of the API.</p>
</div>
<div class="paragraph">
<p>In the next couple of sections we&#8217;ll look closer at the <code>QueryBuilder</code> and the
<code>ResponseBuilder</code> types. We&#8217;ll discuss how to use them in detail, and try to
explain the concepts behind them, and the intention of their implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="querybuilder"><a class="anchor" href="#querybuilder"></a>4.2. <code>QueryBuilder</code></h3>
<div class="paragraph">
<p>The <code>QueryBuilder</code> class is a central point of entry, and provides a fluent
builder-API, for publishing queries. It&#8217;s provided as a bean, by enabling
Query/Response for Spring AMQP, using the <code>@EnableQueryResponse</code> annotation. It may be injected
as a dependency to provide access from methods in any Spring component.</p>
</div>
<div class="paragraph">
<p>We recommend injecting it via the component constructor, and keeping it as a
private field. The <code>findAuthors()</code> method below, shows how to access the
<code>queryBuilder</code> field in order to publish a query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Authors</span> {

    <span class="directive">private</span> <span class="directive">final</span> QueryBuilder queryBuilder;

    <span class="directive">public</span> Authors(QueryBuilder queryBuilder) {
        <span class="local-variable">this</span>.queryBuilder = queryBuilder;
    }

    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;<span class="predefined-type">String</span>&gt; findAuthors() {
        <span class="keyword">return</span> queryBuilder.queryFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class)
            .waitingFor(<span class="integer">800</span>)
            .orEmpty();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the published query is defined by the string <strong>term</strong>
<code>"authors"</code>. This is how the most basic contract of Query/Response is defined. Any
string or text term may be published as a query.</p>
</div>
<div class="paragraph">
<p>The second argument is the expected type of any received response elements. It
is not published with the query, but rather used to coerce or interpret any
received responses. This means that regardless of the payload of any response,
in this case Query/Response for Spring AMQP will attempt to read the response elements as the
declared type <code>String.class</code>.</p>
</div>
<div class="paragraph">
<p>Queries are built and published using the <code>queryFor(..)</code> <em>initial</em> method.
Any following call to one of the <em>terminal</em> methods <code>orEmpty()</code>,
<code>orDefaults(..)</code> and <code>orThrows(..)</code> will build and execute the query, and block
on the calling thread.</p>
</div>
<div class="paragraph">
<p>Since the call above to <code>orEmpty()</code> blocks the thread, users have to specify
one or more query <em>conditionals</em>. In the example above, the call to
<code>waitingFor(..)</code> defines that the call will block for around 800 milliseconds.</p>
</div>
<div class="paragraph">
<p>Constructing queries with the <code>QueryBuilder</code> revolves around creating a
composition of <em>initial</em>, <em>conditional</em>, maybe an optional <em>informal</em> and
exactly one <em>terminal</em> method call. In the table below is a short review of the
different builder methods and their types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <code>QueryBuilder</code> fluid API method types</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queryFor(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>initial</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a new builder for a query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>waitingFor(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>conditional</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the waiting/blocking condition</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>takingAtMost(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>conditional</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a limit condition, a maximum</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>takingAtLeast(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>conditional</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a limit condition, a minimum</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>orEmpty()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>terminal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminates with empty, after conditionals are evaluated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>orDefaults(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>terminal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminates with some defaults, after conditionals are evaluated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>orThrow(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>terminal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminates by throwing, after conditionals are evaluated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onError(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>informal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for explicit logging etc.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let&#8217;s take a closer look at each of the builder method types.</p>
</div>
<div class="sect3">
<h4 id="initial-methods"><a class="anchor" href="#initial-methods"></a>4.2.1. <em>Initial</em> methods</h4>
<div class="paragraph">
<p>At the moment there&#8217;s only one <em>initial</em> method and it&#8217;s declared as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="directive">public</span> &lt;T&gt; ChainingQueryBuilder&lt;T&gt; queryFor(<span class="predefined-type">String</span> term, <span class="predefined-type">Class</span>&lt;T&gt; type)</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can query for any <code>String</code> <strong>term</strong> and given the expected mapped or
coerced <strong>type</strong> as a <code>Class&lt;T&gt;</code>. The returned <code>ChainingQueryBuilder&lt;T&gt;</code>
provides the capabilities of the fluid API.</p>
</div>
</div>
<div class="sect3">
<h4 id="conditional-methods"><a class="anchor" href="#conditional-methods"></a>4.2.2. <em>Conditional</em> methods</h4>
<div class="paragraph">
<p>All <em>conditional</em> properties can be composed together by the <code>QueryResponse</code>
builder API, to define whether a query is successful or not. If an executing
query is completed in a <strong>successful</strong> way, fulfilling the <em>conditionals</em>, it will
return and not consume any more responses.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>waitingFor(..)</code> - defines a timeout <em>conditional</em>. The built query will
evaluate as <strong>successful</strong> if <em>any</em> responses were consumed after the
(approximate) given time limit has elapsed. There are a few different methods
declared, to specify the timeout:</p>
<div class="ulist">
<ul>
<li>
<p><code>waitingFor(long millis)</code></p>
</li>
<li>
<p><code>waitingFor(long amount, TemporalUnit timeUnit)</code></p>
</li>
<li>
<p><code>waitingFor(Duration duration)</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>takingAtMost(int atMost)</code> - defines a limiting <em>conditional</em> on the
aggregated number of received elements. The built query evaluates to
<strong>successful</strong>, and returns, when the given amount is reached.</p>
</li>
<li>
<p><code>takingAtLeast(int atLeast)</code> - defines a minimum <em>conditional</em> on the number
of received element. The built query evaluates to <strong>successful</strong>, only if at
least the given number of elements can be consumed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="terminal-methods"><a class="anchor" href="#terminal-methods"></a>4.2.3. <em>Terminal</em> methods</h4>
<div class="paragraph">
<p>Only one <em>terminal</em> method can be invoked on the builder, per query. It will
ensure that the query is built and executed. All <em>terminal</em> methods are
declared to return <code>Collection&lt;T&gt;</code> where the type parameter <code>&lt;T&gt;</code> is given
in the <em>initial</em> method <code>type</code> parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>orEmpty()</code> - defines the query to return an empty <code>Collection</code> in case the
<em>conditionals</em> do not evaluate to <strong>successful</strong>.</p>
</li>
<li>
<p><code>orDefaults(..)</code> - defines the query to return with some provided <em>defaults</em>
in case the <em>conditionals</em> do not evaluate to <strong>successful</strong>. There are a couple
different methods declared for defaults:</p>
<div class="ulist">
<ul>
<li>
<p><code>orDefaults(Collection&lt;T&gt; defaults)</code> - set at <em>build-time</em>.</p>
</li>
<li>
<p><code>orDefaults(Supplier&lt;Collection&lt;T&gt;&gt; defaults)</code> - supplied at <em>run-time</em>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>orThrow(..)</code> - defines the query to throw an exception in case the
<em>conditionals</em> do not evaluate to <strong>successful</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="informal-methods"><a class="anchor" href="#informal-methods"></a>4.2.4. <em>Informal</em> methods</h4>
<div class="paragraph">
<p>Currently there&#8217;s only one <em>informal</em> builder method, allowing for extended
logging or information capture, in case the query fails or an exception is
thrown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="directive">public</span> ChainingQueryBuilder&lt;T&gt; onError(Consumer&lt;<span class="predefined-type">Throwable</span>&gt; handler)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Try to think more about how the <code>QueryBuilder</code> API covers the exceptional
     query-cases, as part of the composition of <em>conditionals</em>. If clients try
     to use <em>terminals</em> that provide sensible defaults, it may not be necessary
     to build other types of complex recovery or retries.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="querybuilder-examples"><a class="anchor" href="#querybuilder-examples"></a>4.2.5. <code>QueryBuilder</code> examples</h4>
<div class="paragraph">
<p>Below are some examples of how the different <code>QueryBuilder</code> API methods can be
combined.</p>
</div>
<div class="paragraph">
<p>Using <code>takingAtMost(..)</code>, combined with <code>waitingFor(..)</code>, system resources may
be preserved and the client can be protected from consuming too much data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="keyword">return</span> queryBuilder.queryFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class)
                  .takingAtMost(<span class="integer">10</span>)
                  .waitingFor(<span class="integer">800</span>)
                  .orDefaults(Authors.defaults());</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to express constraints at the integration point, also when using
Query/Response for Spring AMQP, throwing on an unfulfilled query, as an option to more lenient
handling with defaults.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="keyword">return</span> queryBuilder.queryFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">offers/rental</span><span class="delimiter">&quot;</span></span>, Offer.class)
                  .takingAtLeast(<span class="integer">10</span>)
                  .takingAtMost(<span class="integer">20</span>)
                  .waitingFor(<span class="integer">2</span>, ChronoUnit.SECONDS)
                  .orThrow(TooFewOffersConstraintException::<span class="keyword">new</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>informal</em> builder feature, allows for transparency into queries that may
have to be observed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="keyword">return</span> queryBuilder.queryFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">offers/rental</span><span class="delimiter">&quot;</span></span>, NewOffer.class)
                  .takingAtLeast(<span class="integer">3</span>)
                  .waitingFor(<span class="integer">400</span>)
                  .onError(error -&gt; LOG.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failure!</span><span class="delimiter">&quot;</span></span>, error))
                  .orThrow(TooFewOffersConstraintException::<span class="keyword">new</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="responsebuilder"><a class="anchor" href="#responsebuilder"></a>4.3. <code>ResponseBuilder</code></h3>
<div class="paragraph">
<p>Another entry-point into Query/Response for Spring AMQP is the <code>ResponseBuilder</code>. It provides a
fluid builder-API that allows users to create responding services or components.</p>
</div>
<div class="paragraph">
<p>It is also provided as a bean, when using the <code>@EnableQueryResponse</code> annotation
in a Spring application. It can easily be injected as a dependency to provide
access from methods in Spring components.</p>
</div>
<div class="paragraph">
<p>The <code>respondWithAuthors()</code> method below, shows how the injected builder is used
to create a responding service. It is invoked by the Spring application context,
on the <code>ApplicationReadyEvent</code> event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OnlyThreeAuthors</span> {

    <span class="directive">private</span> <span class="directive">final</span> ResponseBuilder responseBuilder;

    <span class="directive">public</span> OnlyThreeAuthors(ResponseBuilder responseBuilder) {
        <span class="local-variable">this</span>.responseBuilder = responseBuilder;
    }

    <span class="annotation">@EventListener</span>(ApplicationReadyEvent.class)
    <span class="directive">public</span> <span class="type">void</span> respondWithAuthors() {
        responseBuilder.respondTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class)
            .withAll()
            .from(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tolkien</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Lewis</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Rowling</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the responding service is defined by calling the builder
method <code>respondTo(..)</code> with the query <strong>term</strong> parameter <code>"authors"</code>. It will
be bound to publish the given 3 authors as <code>String.class</code> entries, whenever it
consumes a query for the matching string <strong>term</strong> <code>"authors"</code>.</p>
</div>
<div class="paragraph">
<p>This is the most basic premiss of Query/Response, that any string or text term may be
interpreted as a query - it is however up to the response publisher to
determine what the query means.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
We&#8217;ve tried to provide information around the Query/Response <em>protocol</em> and
     philosophy in the later chapter on <a href="#the-queryresponse-protocol">The Query/Response Protocol</a>. Go
     there to find out more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second parameter is the the type of each element, that will be published in
the response. It is given both as a type hint for the compiler, as well as a
parameter to the data mapper. Here it&#8217;s trivial, the three authors are given as
<code>String.class</code> entries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The data mapper mentioned above, is in fact the
      <code>com.fasterxml.jackson.databind.ObjectMapper</code> and Query/Response for Spring AMQP currently uses
      JSON as the transport format. This means that type hints, JSON mapping
      configuration annotations or custom mappings will apply. However as data
      mapping on the consumer side is done by coercion, the published format
      must conform to some agreed upon standard, shape or protocol.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Response publishers are built using the <code>respondTo(..)</code> <em>initial</em> method. Any
following call to one of the <em>terminal</em> methods <code>from(..)</code> or <code>suppliedBy(..)</code>
will create and register it, as its own consumer in another thread. The
builder call returns immediately.</p>
</div>
<div class="paragraph">
<p>The <code>ResponseBuilder</code> comes with some methods to allow for <em>partitioning</em> or
<em>batching</em>, which can be used to control the transfer of data to some degree.</p>
</div>
<div class="paragraph">
<p>The table below shows a summary of the builder methods and types.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. <code>ResponseBuilder</code> fluid API method types</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>respondTo(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>initial</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates a new builder for a query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>withAll()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>batching</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies NO batches</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>withBatchesOf(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>batching</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the batch size of responses</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>from(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>terminal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminates with some given response data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>suppliedBy(..)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>terminal</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Terminates with some supplied response data</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Let&#8217;s take a closer look at each of the builder method types.</p>
</div>
<div class="sect3">
<h4 id="initial-methods-2"><a class="anchor" href="#initial-methods-2"></a>4.3.1. <em>Initial</em> methods</h4>
<div class="paragraph">
<p>At the moment there&#8217;s only one <em>initial</em> method for building responses. It is
declared as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  <span class="directive">public</span> &lt;T&gt; ChainingResponseBuilder&lt;T&gt; respondTo(<span class="predefined-type">String</span> term, <span class="predefined-type">Class</span>&lt;T&gt; type)</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can create a response for any <code>String</code> <strong>term</strong> and declare that we intend
to publish elements of some <strong>type</strong> given as a <code>Class&lt;T&gt;</code>. The returned
<code>ChainingResponseBuilder&lt;T&gt;</code> provides the capabilities of the fluid API.</p>
</div>
</div>
<div class="sect3">
<h4 id="batching-methods"><a class="anchor" href="#batching-methods"></a>4.3.2. <em>Batching</em> methods</h4>
<div class="paragraph">
<p>Control over how response elements are published can be made by using the
<em>batching</em> methods that the builder provides.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>withAll()</code> - defines that <strong>no</strong> batching should be used, and will publish
all given elements, or try to drain a supplied <code>Iterator</code> all at once.</p>
</li>
<li>
<p><code>withBatchesOf(int size)</code> - defines a batch size, which the response publisher
will use, to create a series of response messages, with up-to the given <code>size</code>
of elements.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="terminal-methods-2"><a class="anchor" href="#terminal-methods-2"></a>4.3.3. <em>Terminal</em> methods</h4>
<div class="paragraph">
<p>Only one <em>terminal</em> method can be called on the builder, per response. It will
ensure that a responder is created and added as a query-consumer, a subscriber
to the query <strong>term</strong> as a topic. It is not attached to the calling thread, so
the builder call always returns after the <em>terminal</em> call.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from(..)</code> - declares the source for the provided response data elements. It
is declared in a few different ways, for alternative use:</p>
<div class="ulist">
<ul>
<li>
<p><code>from(T&#8230;&#8203; elements)</code> - vararg elements</p>
</li>
<li>
<p><code>from(Collection&lt;T&gt; elements)</code> - provided collection at <em>build-time</em></p>
</li>
<li>
<p><code>from(Supplier&lt;Iterator&lt;T&gt;&gt; elements)</code> - supplied iterator at <em>build-time</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>suppliedBy(Supplier&lt;Collection&lt;T&gt;&gt; elements)</code> - declares that response data
is supplied at <em>run-time</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="responsebuilder-examples"><a class="anchor" href="#responsebuilder-examples"></a>4.3.4. <code>ResponseBuilder</code> examples</h4>
<div class="paragraph">
<p>Batch responses provide developers with more options to tune and throttle a
system using Query/Response across many services. It may tune and change the profile
of resource use, in a network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  responseBuilder.respondTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">offers/monday</span><span class="delimiter">&quot;</span></span>, Offer.class)
      .withBatchesOf(<span class="integer">20</span>)
      .from(offers.findAllOffersByDayOfWeek(<span class="predefined-type">Calendar</span>.MONDAY));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dynamic responses are easy to build, with an API that suits modern Java, using
lazy calls to suppliers of data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">  responseBuilder.respondTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">users/current</span><span class="delimiter">&quot;</span></span>, Token.class)
      .withBatchesOf(<span class="integer">128</span>)
      .suppliedBy(userTokenService::findAllCurrentUserTokens);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitoring-ui"><a class="anchor" href="#monitoring-ui"></a>5. Monitoring UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Query/Response for Spring AMQP is intended to be used in a landscape of distributed and highly
decoupled services that exchange information and data. Being able to monitor and
observe them is very important. We provide a monitoring and administration
user interface for this purpose.</p>
</div>
<div class="paragraph">
<p>The latest built version of the Query/Response Monitoring UI can be downloaded as a fat-jar
from <a href="https://github.com/olle/query-response-spring-amqp/raw/main/ui/query-response-ui.jar">https://github.com/olle/query-response-spring-amqp/raw/main/ui/query-response-ui.jar</a>. To start Query/Response Monitoring UI simply run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ java -jar query-response-ui.jar</pre>
</div>
</div>
<div class="sect2">
<h3 id="overview-2"><a class="anchor" href="#overview-2"></a>5.1. Overview</h3>
<div class="paragraph">
<p>The Query/Response Monitoring UI connects to the RabbitMQ broker and listens to metrics and
monitoring information about the live nodes in the current system setup. It
is available at <a href="http://localhost:8080" class="bare">localhost:8080</a>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/ui.png" alt="ui"></span></p>
</div>
<div class="paragraph">
<p>The Query/Response Monitoring UI also provides a simple query-response command line interface,
where users can publish queries and see responses. Since this features is
effectively us <em>eating our own dog food</em> we get a very nice effect, where the
Query/Response Monitoring UI instance is self-visualizing - it shows up as a live-node in the
overview.</p>
</div>
<div class="sect3">
<h4 id="three-golden-metrics"><a class="anchor" href="#three-golden-metrics"></a>5.1.1. Three Golden Metrics</h4>
<div class="paragraph">
<p>The Query/Response Monitoring UI lets us learn about the currently running system. The top most
part provides a few base metrics - our initial <em>golden three:</em> success rate,
latency and throughput.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/metrics.png" alt="metrics"></span></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Overview Metrics</caption>
<colgroup>
<col style="width: 22.2222%;">
<col style="width: 11.1111%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success Rate (<strong>SR</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>percent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The rate of <em>successful</em> queries performed. A query is successful if it
  returns results, which means any predicates, limits or timeouts are also
  successfully evaluated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>SR</strong> Queries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current known count of published queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>SR</strong> Responses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current known count of consumed responses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>SR</strong> Fallbacks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current known count of executed fallbacks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latency (<strong>L</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average measured time for either a query or a response to be published,
  and then consumed. The <em>transport</em> duration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>L</strong> Min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current measured shortest, non zero, latency duration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>L</strong> Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current measured longest latency duration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throughput (<strong>TP</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current measured query and response message publishing rate. <em>Measured
  over a fixed sample size window.</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>TP</strong> Queries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current measured message publishing rate, for queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>TP</strong> Responses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current measured message publishing rate, for responses.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="live-nodes"><a class="anchor" href="#live-nodes"></a>5.1.2. Live Nodes</h4>
<div class="paragraph">
<p>The second section shows some information about the current <em>live nodes</em>, which
means any clients using Query/Response for Spring AMQP, that are currently up and running.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/live-nodes.png" alt="live nodes"></span></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Live Nodes</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Spring Boot app name, or <code>application</code> if it could not be resolved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>pid</code> of the client Java process, or <code>-</code> if it could not be resolved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host name or IP address, or <code>unknown</code> if it could not be resolved.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uptime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The app uptime, or <code>-</code> if it could not be determined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Success Rate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rate of successful queries (<strong>SR</strong>), or <code>-</code> in case the client is only publishing responses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Responses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> Number of published responses (including statistics for the Query/Response Monitoring UI).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Measured latency for queries and responses, the <em>transport</em> duration (<strong>L</strong>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throughput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Publishing rate for queries and responses (<strong>TP</strong>).</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-queryresponse-protocol"><a class="anchor" href="#the-queryresponse-protocol"></a>6. The Query/Response Protocol</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A messaging pattern for building highly decoupled evolving service
architectures.</p>
</div>
<div class="sect2">
<h3 id="a-simple-example"><a class="anchor" href="#a-simple-example"></a>6.1. A simple example</h3>
<div class="paragraph">
<p>Let&#8217;s learn about the Query/Response pattern by walking through a small
fictional example (no pun intended). The technical context is <em>messaging</em> and
hints at some type of broker-based setup - in theory though, any asynchronous
communication could be used. The examples are only pseudo-code and plain-text
data, to keep things simple.</p>
</div>
<div class="sect3">
<h4 id="any-good-sci-fi-books-out-there"><a class="anchor" href="#any-good-sci-fi-books-out-there"></a>6.1.1. Any good sci-fi books out there?</h4>
<div class="paragraph">
<p>Let&#8217;s publish a query.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#42</pre>
</div>
</div>
<div class="paragraph">
<p>The structure above captures all the basic components that a query should
communicate. The term <code>books.sci-fi</code> expresses the published <em>need</em>, and we
can easily understand that it&#8217;s a <em>request</em> for science fiction books.</p>
</div>
<div class="paragraph">
<p><em>The dot-notation is not at all required, the query can use any syntax that
fits the platform or programming language.</em></p>
</div>
<div class="paragraph">
<p>The query has an address where responses should be sent back to:
<code>library/books.sci-fi#42</code>. This is really important, not only in order to
receive responses, but also to avoid coupling the sender to the query. We
don&#8217;t need to state who&#8217;s publishing the query. The <code>reply-to</code> is just an
address, a location or <em>mailbox</em> that can be used for replies.</p>
</div>
<div class="paragraph">
<p>The address is only for this particular query, and it is made to be unique.
In this example <code>library/books.sci-fi#42</code> describes a topic <code>library</code>, and
then the unique mailbox or queue for the query with a hash-code
<code>books.sci-fi#42</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-current-top-3-books"><a class="anchor" href="#the-current-top-3-books"></a>6.1.2. The current top-3 books</h4>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re in luck. We got a response! The information above represents a response
to the query we published. It&#8217;s sent to the address from the query, and carries
a body or payload of information which may be of interest to us.</p>
</div>
<div class="paragraph">
<p>The response does not have to say who it&#8217;s from. This allows us to think about
exchange of information, without the notion of: <em>"A sends a request to B,
which responds to A"</em>. We are making sure that the services are decoupled from
each other, by letting the response be an <em>optional</em> message, sent to the
<em>address</em> instead of a reply to the <em>sender</em>. More about this later.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-asimov-collection"><a class="anchor" href="#the-asimov-collection"></a>6.1.3. The Asimov collection</h4>
<div class="paragraph">
<p>Since our query was published as a notification, we&#8217;re not bound to a single
reply. We can keep on consuming any number of responses that are sent to the
address we published.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>In this response we received a list of book titles which all have the same
author. The previous was a list with popular books. This reply even has one
entry which was already in the first response we received.</p>
</div>
<div class="paragraph">
<p>This is of course not a problem, and it shows us a couple of important things.
Responses may come from different sources and contexts. This means that the
consumer of a response will have to assert the value or <em>usefulness</em> of the
received information, and decide how to handle it.</p>
</div>
<div class="paragraph">
<p><em>The structure of a response should of course conform to some common, agreed
 upon, format or data-shape. More on this later.</em></p>
</div>
<div class="paragraph">
<p>Considering all this, we need to remember <a href="https://en.wikipedia.org/wiki/Robustness_principle">Postel&#8217;s Law</a>. Information
should be liberally handled (interpreted), but publishing should be done
more conservatively. As a consumer of responses we just can&#8217;t have a
guarantee that the information received is valid, well formed or not malicious.
We have to consume, convert and validate with great care. The decoupling in
the Query/Response patter has a price, and this is one part of it.</p>
</div>
<div class="paragraph">
<p><em>But is a published REST-endpoint, for POST requests, that much better? I
 would argue that we still have the same requirements. To be able to handle
 requests liberally, we have to convert and validate, with great care. But
 we are coupling the client and server to each other and, what is perhaps
 even worse, we&#8217;re actually allowing the client to control the writing of
 information inside the server. We have at least surrendered to that model
 of thinking. The POST is a write operation!</em></p>
</div>
<div class="paragraph">
<p><em>To really think and reason about who&#8217;s controlling the write operation, can
 be a very powerful concept in my view. And arguably, the further away we
 can push this authority from the actual, internal act of writing, the less
 we need to think about the complexity of both collaborators at once. This is
 of course the essence of messaging. We could still achieve this with the REST
 endpoint, but I would say that it is a lot harder to avoid thinking about
 the effect of the returned response from the POST request. Even if it is
 empty. We are caught in a lock-step or imperative model.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="no-book-lovers-out-there"><a class="anchor" href="#no-book-lovers-out-there"></a>6.1.4. No book lovers out there?</h4>
<div class="paragraph">
<p>Let&#8217;s rewind the scenario a bit. Let&#8217;s say we&#8217;ve just published the query,
but no responses arrive. What should we do?</p>
</div>
<div class="paragraph">
<p>This is not a flaw in the design, but a specific part of the Query/Response
pattern. It is always up to the consumer of responses (the one that sent
the query), to decide <em>how long</em> it will continue to read, or wait for any to
arrive at all. The pattern does not force this or make any promises.</p>
</div>
<div class="paragraph">
<p>There might be responses. There may be none, a single one or a huge amount.
This is by design, and it forces us to think about important questions, early
in development. Fallback values, proper defaults, circuit-breakers and how
to deal with a flood of responses.</p>
</div>
<div class="paragraph">
<p><em>The most commonly asked question, by developers new to the Query/Response
 pattern, is: "But what if there are no responses, what do I show the user?".
 Exactly! Plan for that. This is something that should be considered early
 in design and development. There might very well be a response, eventually,
 but how long do you let the user wait for a result?</em></p>
</div>
</div>
<div class="sect3">
<h4 id="reprise-surprise"><a class="anchor" href="#reprise-surprise"></a>6.1.5. Reprise, surprise</h4>
<div class="paragraph">
<p>Back to our original scenario. We&#8217;ve received both the top-3, as well as
a collection of Asimov books. And we&#8217;re still open for more responses to the
published address.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"</pre>
</div>
</div>
<div class="paragraph">
<p>Hey, what&#8217;s this! We now received the same response and body payload, as
before. This is still not a problem, and it&#8217;s not a flaw in the pattern. It
is not possible to avoid multiple responses, even from the same publisher. As
a consumer, we have to be ready to handle it. There is nothing wrong with this
response at all.</p>
</div>
<div class="paragraph">
<p><em>The consumer must handle this, and can&#8217;t keep the entries in a simple list. If
 we did, it would contain several duplicate entries. It would be enough to use
 a set instead, so any duplicate entries would only be kept once.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="so-whats-in-the-library"><a class="anchor" href="#so-whats-in-the-library"></a>6.1.6. So, what&#8217;s in the library?</h4>
<div class="paragraph">
<p>Let&#8217;s see what we have.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: library.sci-fi
reply-to: bookshelf/library.sci-fi#1337</pre>
</div>
</div>
<div class="paragraph">
<p>A new query is published and we understand the <code>query</code> term to mean that
there&#8217;s an <em>interest</em> in knowing what books are in the library. A successful
scenario could arrive at the following response being consumed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: bookshelf/library.sci-fi#1337
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>Just as expected.</p>
</div>
</div>
<div class="sect3">
<h4 id="inversion-of-flow"><a class="anchor" href="#inversion-of-flow"></a>6.1.7. Inversion of flow</h4>
<div class="paragraph">
<p>What we&#8217;ve seen in this example scenario is actually an inversion of what
could have been implemented as a tightly coupled, chained set of synchronous
service calls:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A user whishes to view a list of science fiction books through the
<code>Bookshelf</code> service, which needs to call the <code>Library</code> for the list. The
<code>Library</code> service aggregates all sci-fi books by calls to 2 configured
services: <code>Top-3</code> and <code>Authors</code>. Only after both service calls return, can
the <code>Library</code> respond to the <code>Bookshelf</code> and the user is presented with
a list of sci-fi books.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In this type of system, not only are the calls aggregated in the total time,
effectively forcing the user to wait until all calls return, but also to the
availability of each service. This accumulates at the point of the user,
making it highly probable that viewing the list of books will fail.</p>
</div>
<div class="paragraph">
<p><em>There are many ways to work towards better and more resilient solutions, also
 in the synchronous solution. I&#8217;m not trying to say that it is the wrong
 model. The point I&#8217;m trying to make, is the very different way of thinking
 that the Query/Response pattern forces us into from the start. Availability,
 fallbacks, resilience and strict timeouts are called out as key-concepts.</em></p>
</div>
<div class="paragraph">
<p><em>I hope this illustrates what&#8217;s possible using this approach and that I&#8217;ve
 sparked at least som interest in the Query/Response pattern. Later I will
 extend on some of the features and caveats.</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="specification"><a class="anchor" href="#specification"></a>6.2. Specification</h3>
<div class="paragraph">
<p>I&#8217;d like to describe the Query/Response pattern in a more formal but not
too strict way, since it&#8217;s not in any way some type of <em>standard</em> or
<em>protocol</em>. This is a pattern derived from the general idea of expressing a
<em>need</em> or <em>demand</em>, as previously told. It is shaped here, into a specific
version, or flavour, in the <strong>Query/Response pattern</strong>. It simply contains
my recommendations and suggestions on rules or principles to follow.</p>
</div>
<div class="paragraph">
<p>Please, take what you like, leave the rest, and extend as you seem fit.</p>
</div>
<div class="paragraph">
<p>Use of the keywords: "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" are intended
to follow the definitions of <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
</div>
<div class="sect3">
<h4 id="intent"><a class="anchor" href="#intent"></a>6.2.1. Intent</h4>
<div class="paragraph">
<p>The Query/Response pattern aims to describe a model for information sharing
in a distributed system. It does so by using strong decoupling of system
actors and establishing asynchronous message-based high-level data exchange,
as the only means of communication.</p>
</div>
<div class="paragraph">
<p>The following specifications tries to provide a set of rules and guides,
which can be used as an authoritative source for developer, implementing the
pattern.</p>
</div>
</div>
<div class="sect3">
<h4 id="components-and-collaborators"><a class="anchor" href="#components-and-collaborators"></a>6.2.2. Components and Collaborators</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Very small, published notification.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Response</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carries information as payload.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Address</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference to "a mailbox"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Publisher</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">actor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initiates <em>publish</em> method calls.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Consumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">actor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accepts <em>consume</em> method calls.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="query"><a class="anchor" href="#query"></a><code>Query</code></h5>
<div class="paragraph">
<p>A notification that expresses a specific <em>need</em> or <em>whish</em>, which can be
fulfilled by a response, published to a specified return address. The query
MUST state its <em>need</em> or <em>whish</em> in an interpretable way. It may use any
suitable syntax, semantics or language. Most commonly a simple string or term
is used, similar to a message subject, -name or an event <em>routing-key</em>. A
query MUST specify an address for responses, which SHOULD be <em>appropriate</em>
for the stated query and, technically <em>available</em>, as the query is created.</p>
</div>
<div class="paragraph">
<p><em>I very much recommend creating queries with expressions or terms from a
 domain specific, or ubiquitous language. This allows for broader understanding
 and involvement of stakeholders. Keeping queries human readable makes sense.
 It&#8217;s often desirable to use structured terms, with semantics, such as
 filters or parameters. This is quite common and not at all bad.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="response"><a class="anchor" href="#response"></a><code>Response</code></h5>
<div class="paragraph">
<p>A notification, published, as a response to a query, optionally carrying an
information- or data-payload. A response MUST NOT be sent without an intent to
<em>answer</em> a specific query (use event notifications for that). The response
MUST be sent to the address of the query it responds to, without manipulating
it. A response SHOULD carry an appropriate information- or data-payload, with
the intent to answer the query it responds to. Note that this is not a strict
requirement. Responses SHOULD be sent within an appropriate time frame of
seeing a query.</p>
</div>
<div class="paragraph">
<p><em>In most cases it&#8217;s desirable to publish a response as quick as possible,
 after consuming a query.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="address"><a class="anchor" href="#address"></a><code>Address</code></h5>
<div class="paragraph">
<p>Describes and designates an addressable <em>location</em> with the capability to
receive and handle responses. Typically a messaging <em>mailbox</em> or a queue. The
address MUST NOT describe a system actor or collaborator, but instead ensure
decoupling between a publisher and a consumer.</p>
</div>
<div class="paragraph">
<p><em>In messaging or broker based systems, the address is typically a routing key,
 topic or a queue-name.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="publisher"><a class="anchor" href="#publisher"></a><code>Publisher</code></h5>
<div class="paragraph">
<p>An actor that initiates the publishing of a notification, either a query or
a response depending on its current role. The publisher MUST NOT be responsible
for the arrival of any published information. Publishers MUST NOT know any
consumers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The concrete <em>interpolated</em> roles <code>Query-Publisher</code> and
<code>Response-Publisher</code>, does not have to be bound to a single or unique actor.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>It is open for the implementation of the Query/Response pattern to solve or
 choose how it ensures delivery of messages, e.g. using a broker- or queue-
 based messaging system or some other solution for asynchronous communication.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="consumer"><a class="anchor" href="#consumer"></a><code>Consumer</code></h5>
<div class="paragraph">
<p>An actor that willingly yields to the consumption of notifications, from some
external source, either a response or a query depending on its current role.
Consumers MUST NOT know any publishers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The concrete <em>interpolated</em> roles <code>Query-Consumer</code> and
<code>Response-Consumer</code>, does not have to be bound to a single or unique actor.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="methods-and-actions"><a class="anchor" href="#methods-and-actions"></a>6.2.3. Methods and Actions</h4>
<div class="paragraph">
<p><em>Nothing in the Query/Response pattern is synchronous, or based on the notion
 of guaranteed delivery (or only-once semantics). The following structured
 step-by-step description is only for documentation purposes, and does not,
 in any way, define a sequence which can be relied upon.</em></p>
</div>
<div class="sect4">
<h5 id="prepare-address"><a class="anchor" href="#prepare-address"></a>Prepare <code>Address</code></h5>
<div class="paragraph">
<p>Before publishing a query, the query publisher SHOULD ensure that an
appropriate address, specified for the query, can be handled.</p>
</div>
<div class="paragraph">
<p><em>Implementations are free to use a best-effort approach. It may be that the
only option is to use short-lived or temporary resources, which may or may
not fail to be allocated. Therefore there&#8217;s no strict requirement to ensure
that the address can be handled.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="publish-query"><a class="anchor" href="#publish-query"></a>Publish <code>Query</code></h5>
<div class="paragraph">
<p>The query publisher can, at any time, choose to publish a query. No ACK or
NACK will be provided and the query publisher MUST NOT assume that the query
has been consumed, or that a response will be returned at this time. The
publisher SHOULD consider the case where the query is lost, examine options
to detect and repair this, if possible; <em>timeouts, retries or fallbacks are
perhaps options to investigate</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="consume-query"><a class="anchor" href="#consume-query"></a>Consume <code>Query</code></h5>
<div class="paragraph">
<p>A query consumer, that is willingly listening for queries, may at any time
receive, and choose to handle a query. Consuming queries is an unbound
operation. The consumer SHOULD handle queries with an intent to provide a
response, or ignore the query. A consumer MAY decide to publish none, one or
any number of responses to the query - it is optional. A consumer MAY at any
time choose to stop listening for queries.</p>
</div>
<div class="paragraph">
<p><em>Please note that the Query/Response pattern does not protect against
query consumers with harmful intent. Implementations should consider issues
like security, encryption and trust as extensions to it.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="publish-response"><a class="anchor" href="#publish-response"></a>Publish <code>Response</code></h5>
<div class="paragraph">
<p>A response publisher MUST use the provided address of the query it responds to,
when publishing responses. No ACK or NACK will be provided and the publisher
MUST NOT assume that the response has been delivered, arrived properly or
consumed.</p>
</div>
</div>
<div class="sect4">
<h5 id="consume-response"><a class="anchor" href="#consume-response"></a>Consume <code>Response</code></h5>
<div class="paragraph">
<p>A response consumer, listening for responses at a previously created address,
MAY at any time receive one or several responses - or not at all. Consuming
responses is an unbounded operation. Any received response MAY have a payload
or body of information. The consumer SHOULD assert and validate any
transferred information with great care. A consumer MAY at any time choose to
stop listening for responses.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-example-revisited"><a class="anchor" href="#the-example-revisited"></a>6.3. The example revisited</h3>
<div class="paragraph">
<p>Let&#8217;s examine one of the most powerful aspects of using the Query/Response
pattern. If we think back to our initial example we published a query for
books in the sci-fi genre.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#42</pre>
</div>
</div>
<div class="paragraph">
<p>We also learned that responses may come from different sources, with different
payloads and we are responsible for dealing with validation and duplicates etc.</p>
</div>
<div class="paragraph">
<p>The query in this example uses only some minimal semantics to express the
genre of books requested, the term <code>sci-fi</code>. This is part of a contract from
our domain, together with rules on how any result payload should be presented.
The list of strings within quotes are not by accident, it is also by design.</p>
</div>
<div class="paragraph">
<p>The Query/Response pattern does not enforce any structural rules for query,
address or response syntax. This must come from designers and developers. <em>I
would suggest, using <a href="https://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> to leverage the power of
a ubiquitous language in the queries</em>.</p>
</div>
<div class="paragraph">
<p>All this together puts us in a position to allow change and evolution in our
system.</p>
</div>
<div class="sect3">
<h4 id="a-better-library-protocol"><a class="anchor" href="#a-better-library-protocol"></a>6.3.1. A better library protocol</h4>
<div class="paragraph">
<p>We have agreed on supporting <em>stars</em> for book ratings, and different teams
scramble to their stations to extend for the new feature.</p>
</div>
<div class="paragraph">
<p>We saw earlier that data returned was formed as a list of quoted strings, and
the contract for parsing was: "first quoted string per line is book title".</p>
</div>
<div class="literalblock">
<div class="content">
<pre>body:
  "Neuromancer"</pre>
</div>
</div>
<div class="paragraph">
<p>That rule and the capability to extend it, made it possible to agree on a new
optional format: "trailing key-values are properties". For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>body:
  "Neuromancer" isbn:9780307969958 stars:4</pre>
</div>
</div>
<div class="paragraph">
<p>This is great. Let&#8217;s get to work.</p>
</div>
</div>
<div class="sect3">
<h4 id="top-3-books-have-stars"><a class="anchor" href="#top-3-books-have-stars"></a>6.3.2. Top-3 books have stars</h4>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#77</pre>
</div>
</div>
<div class="paragraph">
<p>At a later time a new query for science fiction books is published. Now, we
still must not assume anything about the service or collaborator publishing
the query. It may be that we have a new service running in our system, not yet
live, or an updated version of the first one - we don&#8217;t need to know.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "Neuromancer" stars:3
  "Snow Crash" stars:5
  "I, Robot" stars:4</pre>
</div>
</div>
<div class="paragraph">
<p>The first response looks great, it&#8217;s using the new extended protocol and
provides star-ratings with the top-3 sci-fi book list.</p>
</div>
</div>
<div class="sect3">
<h4 id="one-of-each-flavour"><a class="anchor" href="#one-of-each-flavour"></a>6.3.3. One of each flavour</h4>
<div class="paragraph">
<p>Another response is consumed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>Oh, ok seems that we&#8217;ve received a response with only Asimov books again, and
sadly no stars. Luckily the protocol rules allows us to still use the response
if we choose to.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "I, Robot" stars:2
  "The Gods Themselves"
  "Pebble in the Sky" stars:5</pre>
</div>
</div>
<div class="paragraph">
<p>And what is this now. We&#8217;ve consumed yet another response and it appears to be
the Asimov list again, but this time with star-ratings, but only for a few
titles.</p>
</div>
<div class="paragraph">
<p>This is quite normal and shows us a really important and valuable aspect of
the Query/Response pattern. If we would pull the curtain back a bit, it could
be reasonable to assume that the publisher of Asimov books now exists in 2
distinct versions. One supports the new updated format, and has a couple of
star-ratings set. The other appears to be the <em>older</em> version.</p>
</div>
<div class="paragraph">
<p>We have effectively seen how response publishers can evolve, and even exist
side-by-side, if care is taken to design a suitable payload protocol.</p>
</div>
<div class="paragraph">
<p><em>The backward compatibility of the payload format is not at all required in the
 Query/Response pattern. Implementations could use version tags or classifiers
 to check for compatibility at the consumer side.</em></p>
</div>
<div class="paragraph">
<p>The key point here is, the consumer is still responsible for asserting the
usefulness and value of the response information. Parsing, validating or
checking for version compatibility is required.</p>
</div>
</div>
<div class="sect3">
<h4 id="out-with-the-old"><a class="anchor" href="#out-with-the-old"></a>6.3.4. Out with the old</h4>
<div class="paragraph">
<p>Let&#8217;s jump forward and say that at some later time, the query for sci-fi books
is published again.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#88</pre>
</div>
</div>
<div class="paragraph">
<p>And this time, the only consumed response with Asimov books is the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#88
body:
  "I, Robot" stars:3
  "The Gods Themselves" stars:3
  "Pebble in the Sky" stars:5</pre>
</div>
</div>
<div class="paragraph">
<p>We can almost certainly conclude that the original version of the Asimov
book service has been shut down.</p>
</div>
<div class="paragraph">
<p>Again we can see how the Query/Response pattern helps in coping with a natural
evolution of the system. Services can be added, removed or upgraded at any
time.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="queryresponse-maturity-model"><a class="anchor" href="#queryresponse-maturity-model"></a>6.4. Query/Response Maturity Model</h3>
<div class="paragraph">
<p>Just like with the <a href="https://martinfowler.com/articles/richardsonMaturityModel.html">Richardson Maturity Model</a>, I&#8217;ve identified an
evolution of maturity around the acceptance, use and implementation of
Query/Response. It describes the benefits, opportunities and also
complexities, pretty well.</p>
</div>
<div class="sect3">
<h4 id="level-0-purgatory"><a class="anchor" href="#level-0-purgatory"></a>6.4.1. Level 0 - Purgatory</h4>
<div class="paragraph">
<p>All communication and exchange is bound to fixed, configured, service end-
points. Synchronous blocking calls exchange information based on formats
declared in project Wiki-pages or Word-documents. Most solutions are stateless,
with I/O bound performance. Changes typically require system wide,
synchronized, upgrades. This lead to development dropping in velocity, as each
module or team will find it hard or impossible to act independently of each
other.</p>
</div>
</div>
<div class="sect3">
<h4 id="level-1"><a class="anchor" href="#level-1"></a>6.4.2. Level 1</h4>
<div class="paragraph">
<p>Using the Query/Response pattern for the first time often leads to healthy
temporal decoupling pretty quick. But with a lot of code still written with
a synchronous model in mind, the data exchange tend to look a bit like <em>sync</em>.
Solutions move towards being stateful, but loosen their I/O-bound performance
characteristics. It&#8217;s hard for developer to think about queries and responses
not coming from known components. Already at this level teams and modules gain
a lot in the capability to move independently. Releases and deployment is
practically not a tangle any more, although the view on evolutionary
data-structures or protocols for data, may lag behind and still be
Wiki/Document-based.</p>
</div>
</div>
<div class="sect3">
<h4 id="level-2"><a class="anchor" href="#level-2"></a>6.4.3. Level 2</h4>
<div class="paragraph">
<p>At this level a deeper insight into the value of a proper data-structure or
protocol for payload, which can evolve as required, is often gained. With
this comes the extended benefit of seamless upgrades and service evolution.
Developers get to experience how responsibilities can move without breaking
or changing any integration code - response publishers can change owners and
location.</p>
</div>
</div>
<div class="sect3">
<h4 id="level-3"><a class="anchor" href="#level-3"></a>6.4.4. Level 3</h4>
<div class="paragraph">
<p>More and more ideas around reactivity and flexibility begin to take form.
Events can immediately trigger queries which may enrich a local context based
on current needs. This moves the design and use beyond a system using sync,
and durable persistent state, to a more ephemeral and <em>living</em> model. The data
structure of payloads tend to be less bound to strict <em>types</em> and more
malleable <em>data shapes</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="level-4-and-beyond"><a class="anchor" href="#level-4-and-beyond"></a>6.4.5. Level 4 and beyond&#8230;&#8203;</h4>
<div class="paragraph">
<p>Information exchange using the Query/Response pattern allows for almost
limitless evolution of services, or components, no longer bound to versions or
availability. The structure of any data is also very dynamic, information can
be partial, enriched, or come in different sets, from different publishers. No
schema is required at this level, but <em>data shapes</em> are used, which can be
embraced by all collaborators in the architecture. Queries are sent and
responses consumed, sometimes within deliberate timeouts; take-until semantics.
This way modules can provide, and fulfill, explicit SLAs if required.</p>
</div>
<div class="paragraph">
<p><em>This is of course not supposed to be taken too seriously, but the maturity
 levels describes a journey, from a strict and stale model, into one where
 evolution and change is quite normal.</em></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendicies"><a class="anchor" href="#appendicies"></a>7. Appendicies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="java-api"><a class="anchor" href="#java-api"></a>7.1. Java API</h3>
<div class="paragraph">
<p>We keep a recent link available here to the most recently built and deployed
<a href="apidocs/index.html">Java API Documentation</a> for Query/Response for Spring AMQP.</p>
</div>
</div>
<div class="sect2">
<h3 id="amqp-resources-formats"><a class="anchor" href="#amqp-resources-formats"></a>7.2. AMQP Resources &amp; Formats</h3>
<div class="paragraph">
<p>The declared <a href="https://www.rabbitmq.com/protocol.html">AMQP</a> broker resources are very limited. Only the
<code>query-response</code> topic-exchange is created. All active Query/Response services
will automatically declare the required exchange, with the following parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  name: query-response
  type: topic
  auto-delete: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Query/Response library defines a small set of properties and data-formats,
which are used in the AMQP messages - a mini-protocol:</p>
</div>
<div class="sect3">
<h4 id="query-messages"><a class="anchor" href="#query-messages"></a>7.2.1. Query messages</h4>
<div class="paragraph">
<p>Query messages are very simple in structure and form. The common
<code>query-response</code> exchanged is published to, and the message <code>routing-key</code> will
carry the specific <code>query-term</code> that is requested. The <code>reply-to</code> header
property is set to the queue name of a generated <code>query-response-queue</code>,
specific to the published query.</p>
</div>
<div class="paragraph">
<p>Both query and response messages use the <code>application/json</code> content-type. There
is no further content in the body, just an empty JSON object <code>{}</code>, as a
placeholder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  exchange: query-response
  routing-key: ${query-term}
  reply-to: ${query-response-queue}
  content-type: application/json
  body:
  {}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="response-messages"><a class="anchor" href="#response-messages"></a>7.2.2. Response messages</h4>
<div class="paragraph">
<p>Published responses also use a common format. They are published to the empty
(default) exchange, with the <code>query-response-queue</code> from the <code>reply-to</code>
property of a consumed query as the <code>routing-key</code>. This will cause a direct
routing of responses back to the declared response-queue.</p>
</div>
<div class="paragraph">
<p>The response body payload JSON structure always wraps the <code>elements</code> collection
containing the actual response data in an <em>envelope object</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  exchange: (default)
  routing-key: ${query-response-queue}
  content-type: application/json
  body:
  {
    elements: [...]
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The current properties of Query/Response messages are simple but provide
room for extensions in future versions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trademarks"><a class="anchor" href="#trademarks"></a>7.3. Trademarks</h3>
<div class="paragraph">
<p>Java is a registered trademark of <a href="https://www.oracle.com">Oracle</a> and/or its affiliates.
Other names may be trademarks of their respective owners.</p>
</div>
<div class="paragraph">
<p>Spring and Spring Boot are trademarks of <a href="https://www.pivotal.io">Pivotal</a>
Software, Inc. in the U.S. and other countries.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-03-06 16:41:17 +0100
</div>
</div>
</body>
</html>