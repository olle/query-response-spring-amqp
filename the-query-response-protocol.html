<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>The Query/Response Protocol</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>The Query/Response Protocol</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_a_simple_example">A simple example</a>
<ul class="sectlevel2">
<li><a href="#_any_good_sci_fi_books_out_there">Any good sci-fi books out there?</a></li>
<li><a href="#_the_current_top_3_books">The current top-3 books</a></li>
<li><a href="#_the_asimov_collection">The Asimov collection</a></li>
<li><a href="#_no_book_lovers_out_there">No book lovers out there?</a></li>
<li><a href="#_reprise_surprise">Reprise, surprise</a></li>
<li><a href="#_so_whats_in_the_library">So, what&#8217;s in the library?</a></li>
<li><a href="#_inversion_of_flow">Inversion of flow</a></li>
</ul>
</li>
<li><a href="#_specification">Specification</a>
<ul class="sectlevel2">
<li><a href="#_intent">Intent</a></li>
<li><a href="#_components_and_collaborators">Components and Collaborators</a></li>
<li><a href="#_methods_and_actions">Methods and Actions</a></li>
</ul>
</li>
<li><a href="#_the_example_revisited">The example revisited</a>
<ul class="sectlevel2">
<li><a href="#_a_better_library_protocol">A better library protocol</a></li>
<li><a href="#_top_3_books_have_stars">Top-3 books have stars</a></li>
<li><a href="#_one_of_each_flavour">One of each flavour</a></li>
<li><a href="#_out_with_the_old">Out with the old</a></li>
</ul>
</li>
<li><a href="#_queryresponse_maturity_model">Query/Response Maturity Model</a>
<ul class="sectlevel2">
<li><a href="#_level_0_purgatory">Level 0 - Purgatory</a></li>
<li><a href="#_level_1">Level 1</a></li>
<li><a href="#_level_2">Level 2</a></li>
<li><a href="#_level_3">Level 3</a></li>
<li><a href="#_level_4_and_beyond">Level 4 and beyond&#8230;&#8203;</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A messaging pattern for building highly decoupled evolving service
architectures.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_simple_example">A simple example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s learn about the Query/Response pattern by walking through a small
fictional example (no pun intended). The technical context is <em>messaging</em> and
hints at some type of broker-based setup - in theory though, any asynchronous
communication could be used. The examples are only pseudo-code and plain-text
data, to keep things simple.</p>
</div>
<div class="sect2">
<h3 id="_any_good_sci_fi_books_out_there">Any good sci-fi books out there?</h3>
<div class="paragraph">
<p>Let&#8217;s publish a query.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#42</pre>
</div>
</div>
<div class="paragraph">
<p>The structure above captures all the basic components that a query should
communicate. The term <code>books.sci-fi</code> expresses the published <em>need</em>, and we
can easily understand that it&#8217;s a <em>request</em> for science fiction books.</p>
</div>
<div class="paragraph">
<p><em>The dot-notation is not at all required, the query can use any syntax that
fits the platform or programming language.</em></p>
</div>
<div class="paragraph">
<p>The query has an address where responses should be sent back to:
<code>library/books.sci-fi#42</code>. This is really important, not only in order to
receive responses, but also to avoid coupling the sender to the query. We
don&#8217;t need to state who&#8217;s publishing the query. The <code>reply-to</code> is just an
address, a location or <em>mailbox</em> that can be used for replies.</p>
</div>
<div class="paragraph">
<p>The address is only for this particular query, and it is made to be unique.
In this example <code>library/books.sci-fi#42</code> describes a topic <code>library</code>, and
then the unique mailbox or queue for the query with a hash-code
<code>books.sci-fi#42</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_current_top_3_books">The current top-3 books</h3>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re in luck. We got a response! The information above represents a response
to the query we published. It&#8217;s sent to the address from the query, and carries
a body or payload of information which may be of interest to us.</p>
</div>
<div class="paragraph">
<p>The response does not have to say who it&#8217;s from. This allows us to think about
exchange of information, without the notion of: <em>"A sends a request to B,
which responds to A"</em>. We are making sure that the services are decoupled from
each other, by letting the response be an <em>optional</em> message, sent to the
<em>address</em> instead of a reply to the <em>sender</em>. More about this later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_asimov_collection">The Asimov collection</h3>
<div class="paragraph">
<p>Since our query was published as a notification, we&#8217;re not bound to a single
reply. We can keep on consuming any number of responses that are sent to the
address we published.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>In this response we received a list of book titles which all have the same
author. The previous was a list with popular books. This reply even has one
entry which was already in the first response we received.</p>
</div>
<div class="paragraph">
<p>This is of course not a problem, and it shows us a couple of important things.
Responses may come from different sources and contexts. This means that the
consumer of a response will have to assert the value or <em>usefulness</em> of the
received information, and decide how to handle it.</p>
</div>
<div class="paragraph">
<p><em>The structure of a response should of course conform to some common, agreed
 upon, format or data-shape. More on this later.</em></p>
</div>
<div class="paragraph">
<p>Considering all this, we need to remember <a href="https://en.wikipedia.org/wiki/Robustness_principle">Postel&#8217;s Law</a>. Information
should be liberally handled (interpreted), but publishing should be done
more conservatively. As a consumer of responses we just can&#8217;t have a
guarantee that the information received is valid, well formed or not malicious.
We have to consume, convert and validate with great care. The decoupling in
the Query/Response patter has a price, and this is one part of it.</p>
</div>
<div class="paragraph">
<p><em>But is a published REST-endpoint, for POST requests, that much better? I
 would argue that we still have the same requirements. To be able to handle
 requests liberally, we have to convert and validate, with great care. But
 we are coupling the client and server to each other and, what is perhaps
 even worse, we&#8217;re actually allowing the client to control the writing of
 information inside the server. We have at least surrendered to that model
 of thinking. The POST is a write operation!</em></p>
</div>
<div class="paragraph">
<p><em>To really think and reason about who&#8217;s controlling the write operation, can
 be a very powerful concept in my view. And arguably, the further away we
 can push this authority from the actual, internal act of writing, the less
 we need to think about the complexity of both collaborators at once. This is
 of course the essence of messaging. We could still achieve this with the REST
 endpoint, but I would say that it is a lot harder to avoid thinking about
 the effect of the returned response from the POST request. Even if it is
 empty. We are caught in a lock-step or imperative model.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_no_book_lovers_out_there">No book lovers out there?</h3>
<div class="paragraph">
<p>Let&#8217;s rewind the scenario a bit. Let&#8217;s say we&#8217;ve just published the query,
but no responses arrive. What should we do?</p>
</div>
<div class="paragraph">
<p>This is not a flaw in the design, but a specific part of the Query/Response
pattern. It is always up to the consumer of responses (the one that sent
the query), to decide <em>how long</em> it will continue to read, or wait for any to
arrive at all. The pattern does not force this or make any promises.</p>
</div>
<div class="paragraph">
<p>There might be responses. There may be none, a single one or a huge amount.
This is by design, and it forces us to think about important questions, early
in development. Fallback values, proper defaults, circuit-breakers and how
to deal with a flood of responses.</p>
</div>
<div class="paragraph">
<p><em>The most commonly asked question, by developers new to the Query/Response
 pattern, is: "But what if there are no responses, what do I show the user?".
 Exactly! Plan for that. This is something that should be considered early
 in design and development. There might very well be a response, eventually,
 but how long do you let the user wait for a result?</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_reprise_surprise">Reprise, surprise</h3>
<div class="paragraph">
<p>Back to our original scenario. We&#8217;ve received both the top-3, as well as
a collection of Asimov books. And we&#8217;re still open for more responses to the
published address.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#42
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"</pre>
</div>
</div>
<div class="paragraph">
<p>Hey, what&#8217;s this! We now received the same response and body payload, as
before. This is still not a problem, and it&#8217;s not a flaw in the pattern. It
is not possible to avoid multiple responses, even from the same publisher. As
a consumer, we have to be ready to handle it. There is nothing wrong with this
response at all.</p>
</div>
<div class="paragraph">
<p><em>The consumer must handle this, and can&#8217;t keep the entries in a simple list. If
 we did, it would contain several duplicate entries. It would be enough to use
 a set instead, so any duplicate entries would only be kept once.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_so_whats_in_the_library">So, what&#8217;s in the library?</h3>
<div class="paragraph">
<p>Let&#8217;s see what we have.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: library.sci-fi
reply-to: bookshelf/library.sci-fi#1337</pre>
</div>
</div>
<div class="paragraph">
<p>A new query is published and we understand the <code>query</code> term to mean that
there&#8217;s an <em>interest</em> in knowing what books are in the library. A successful
scenario could arrive at the following response being consumed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: bookshelf/library.sci-fi#1337
body:
  "Neuromancer"
  "Snow Crash"
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>Just as expected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inversion_of_flow">Inversion of flow</h3>
<div class="paragraph">
<p>What we&#8217;ve seen in this example scenario is actually an inversion of what
could have been implemented as a tightly coupled, chained set of synchronous
service calls:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A user whishes to view a list of science fiction books through the
<code>Bookshelf</code> service, which needs to call the <code>Library</code> for the list. The
<code>Library</code> service aggregates all sci-fi books by calls to 2 configured
services: <code>Top-3</code> and <code>Authors</code>. Only after both service calls return, can
the <code>Library</code> respond to the <code>Bookshelf</code> and the user is presented with
a list of sci-fi books.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In this type of system, not only are the calls aggregated in the total time,
effectively forcing the user to wait until all calls return, but also to the
availability of each service. This accumulates at the point of the user,
making it highly probable that viewing the list of books will fail.</p>
</div>
<div class="paragraph">
<p><em>There are many ways to work towards better and more resilient solutions, also
 in the synchronous solution. I&#8217;m not trying to say that it is the wrong
 model. The point I&#8217;m trying to make, is the very different way of thinking
 that the Query/Response pattern forces us into from the start. Availability,
 fallbacks, resilience and strict timeouts are called out as key-concepts.</em></p>
</div>
<div class="paragraph">
<p><em>I hope this illustrates what&#8217;s possible using this approach and that I&#8217;ve
 sparked at least som interest in the Query/Response pattern. Later I will
 extend on some of the features and caveats.</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification">Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;d like to describe the Query/Response pattern in a more formal but not
too strict way, since it&#8217;s not in any way some type of <em>standard</em> or
<em>protocol</em>. This is a pattern derived from the general idea of expressing a
<em>need</em> or <em>demand</em>, as previously told. It is shaped here, into a specific
version, or flavour, in the <strong>Query/Response pattern</strong>. It simply contains
my recommendations and suggestions on rules or principles to follow.</p>
</div>
<div class="paragraph">
<p>Please, take what you like, leave the rest, and extend as you seem fit.</p>
</div>
<div class="paragraph">
<p>Use of the keywords: "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" are intended
to follow the definitions of <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
</div>
<div class="sect2">
<h3 id="_intent">Intent</h3>
<div class="paragraph">
<p>The Query/Response pattern aims to describe a model for information sharing
in a distributed system. It does so by using strong decoupling of system
actors and establishing asynchronous message-based high-level data exchange,
as the only means of communication.</p>
</div>
<div class="paragraph">
<p>The following specifications tries to provide a set of rules and guides,
which can be used as an authoritative source for developer, implementing the
pattern.</p>
</div>
</div>
<div class="sect2">
<h3 id="_components_and_collaborators">Components and Collaborators</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Query</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Very small, published notification.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Response</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carries information as payload.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Address</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference to "a mailbox"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Publisher</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">actor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initiates <em>publish</em> method calls.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Consumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">actor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accepts <em>consume</em> method calls.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_query"><code>Query</code></h4>
<div class="paragraph">
<p>A notification that expresses a specific <em>need</em> or <em>whish</em>, which can be
fulfilled by a response, published to a specified return address. The query
MUST state its <em>need</em> or <em>whish</em> in an interpretable way. It may use any
suitable syntax, semantics or language. Most commonly a simple string or term
is used, similar to a message subject, -name or an event <em>routing-key</em>. A
query MUST specify an address for responses, which SHOULD be <em>appropriate</em>
for the stated query and, technically <em>available</em>, as the query is created.</p>
</div>
<div class="paragraph">
<p><em>I very much recommend creating queries with expressions or terms from a
 domain specific, or ubiquitous language. This allows for broader understanding
 and involvement of stakeholders. Keeping queries human readable makes sense.
 It&#8217;s often desirable to use structured terms, with semantics, such as
 filters or parameters. This is quite common and not at all bad.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_response"><code>Response</code></h4>
<div class="paragraph">
<p>A notification, published, as a response to a query, optionally carrying an
information- or data-payload. A response MUST NOT be sent without an intent to
<em>answer</em> a specific query (use event notifications for that). The response
MUST be sent to the address of the query it responds to, without manipulating
it. A response SHOULD carry an appropriate information- or data-payload, with
the intent to answer the query it responds to. Note that this is not a strict
requirement. Responses SHOULD be sent within an appropriate time frame of
seeing a query.</p>
</div>
<div class="paragraph">
<p><em>In most cases it&#8217;s desirable to publish a response as quick as possible,
 after consuming a query.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_address"><code>Address</code></h4>
<div class="paragraph">
<p>Describes and designates an addressable <em>location</em> with the capability to
receive and handle responses. Typically a messaging <em>mailbox</em> or a queue. The
address MUST NOT describe a system actor or collaborator, but instead ensure
decoupling between a publisher and a consumer.</p>
</div>
<div class="paragraph">
<p><em>In messaging or broker based systems, the address is typically a routing key,
 topic or a queue-name.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_publisher"><code>Publisher</code></h4>
<div class="paragraph">
<p>An actor that initiates the publishing of a notification, either a query or
a response depending on its current role. The publisher MUST NOT be responsible
for the arrival of any published information. Publishers MUST NOT know any
consumers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The concrete <em>interpolated</em> roles <code>Query-Publisher</code> and
<code>Response-Publisher</code>, does not have to be bound to a single or unique actor.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>It is open for the implementation of the Query/Response pattern to solve or
 choose how it ensures delivery of messages, e.g. using a broker- or queue-
 based messaging system or some other solution for asynchronous communication.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_consumer"><code>Consumer</code></h4>
<div class="paragraph">
<p>An actor that willingly yields to the consumption of notifications, from some
external source, either a response or a query depending on its current role.
Consumers MUST NOT know any publishers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The concrete <em>interpolated</em> roles <code>Query-Consumer</code> and
<code>Response-Consumer</code>, does not have to be bound to a single or unique actor.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_methods_and_actions">Methods and Actions</h3>
<div class="paragraph">
<p><em>Nothing in the Query/Response pattern is synchronous, or based on the notion
 of guaranteed delivery (or only-once semantics). The following structured
 step-by-step description is only for documentation purposes, and does not,
 in any way, define a sequence which can be relied upon.</em></p>
</div>
<div class="sect3">
<h4 id="_prepare_address">Prepare <code>Address</code></h4>
<div class="paragraph">
<p>Before publishing a query, the query publisher SHOULD ensure that an
appropriate address, specified for the query, can be handled.</p>
</div>
<div class="paragraph">
<p><em>Implementations are free to use a best-effort approach. It may be that the
only option is to use short-lived or temporary resources, which may or may
not fail to be allocated. Therefore there&#8217;s no strict requirement to ensure
that the address can be handled.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_publish_query">Publish <code>Query</code></h4>
<div class="paragraph">
<p>The query publisher can, at any time, choose to publish a query. No ACK or
NACK will be provided and the query publisher MUST NOT assume that the query
has been consumed, or that a response will be returned at this time. The
publisher SHOULD consider the case where the query is lost, examine options
to detect and repair this, if possible; <em>timeouts, retries or fallbacks are
perhaps options to investigate</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consume_query">Consume <code>Query</code></h4>
<div class="paragraph">
<p>A query consumer, that is willingly listening for queries, may at any time
receive, and choose to handle a query. Consuming queries is an unbound
operation. The consumer SHOULD handle queries with an intent to provide a
response, or ignore the query. A consumer MAY decide to publish none, one or
any number of responses to the query - it is optional. A consumer MAY at any
time choose to stop listening for queries.</p>
</div>
<div class="paragraph">
<p><em>Please note that the Query/Response pattern does not protect against
query consumers with harmful intent. Implementations should consider issues
like security, encryption and trust as extensions to it.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_publish_response">Publish <code>Response</code></h4>
<div class="paragraph">
<p>A response publisher MUST use the provided address of the query it responds to,
when publishing responses. No ACK or NACK will be provided and the publisher
MUST NOT assume that the response has been delivered, arrived properly or
consumed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_consume_response">Consume <code>Response</code></h4>
<div class="paragraph">
<p>A response consumer, listening for responses at a previously created address,
MAY at any time receive one or several responses - or not at all. Consuming
responses is an unbounded operation. Any received response MAY have a payload
or body of information. The consumer SHOULD assert and validate any
transferred information with great care. A consumer MAY at any time choose to
stop listening for responses.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_example_revisited">The example revisited</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s examine one of the most powerful aspects of using the Query/Response
pattern. If we think back to our initial example we published a query for
books in the sci-fi genre.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#42</pre>
</div>
</div>
<div class="paragraph">
<p>We also learned that responses may come from different sources, with different
payloads and we are responsible for dealing with validation and duplicates etc.</p>
</div>
<div class="paragraph">
<p>The query in this example uses only some minimal semantics to express the
genre of books requested, the term <code>sci-fi</code>. This is part of a contract from
our domain, together with rules on how any result payload should be presented.
The list of strings within quotes are not by accident, it is also by design.</p>
</div>
<div class="paragraph">
<p>The Query/Response pattern does not enforce any structural rules for query,
address or response syntax. This must come from designers and developers. <em>I
would suggest, using <a href="https://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> to leverage the power of
a ubiquitous language in the queries</em>.</p>
</div>
<div class="paragraph">
<p>All this together puts us in a position to allow change and evolution in our
system.</p>
</div>
<div class="sect2">
<h3 id="_a_better_library_protocol">A better library protocol</h3>
<div class="paragraph">
<p>We have agreed on supporting <em>stars</em> for book ratings, and different teams
scramble to their stations to extend for the new feature.</p>
</div>
<div class="paragraph">
<p>We saw earlier that data returned was formed as a list of quoted strings, and
the contract for parsing was: "first quoted string per line is book title".</p>
</div>
<div class="literalblock">
<div class="content">
<pre>body:
  "Neuromancer"</pre>
</div>
</div>
<div class="paragraph">
<p>That rule and the capability to extend it, made it possible to agree on a new
optional format: "trailing key-values are properties". For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>body:
  "Neuromancer" isbn:9780307969958 stars:4</pre>
</div>
</div>
<div class="paragraph">
<p>This is great. Let&#8217;s get to work.</p>
</div>
</div>
<div class="sect2">
<h3 id="_top_3_books_have_stars">Top-3 books have stars</h3>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#77</pre>
</div>
</div>
<div class="paragraph">
<p>At a later time a new query for science fiction books is published. Now, we
still must not assume anything about the service or collaborator publishing
the query. It may be that we have a new service running in our system, not yet
live, or an updated version of the first one - we don&#8217;t need to know.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "Neuromancer" stars:3
  "Snow Crash" stars:5
  "I, Robot" stars:4</pre>
</div>
</div>
<div class="paragraph">
<p>The first response looks great, it&#8217;s using the new extended protocol and
provides star-ratings with the top-3 sci-fi book list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_one_of_each_flavour">One of each flavour</h3>
<div class="paragraph">
<p>Another response is consumed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "I, Robot"
  "The Gods Themselves"
  "Pebble in the Sky"</pre>
</div>
</div>
<div class="paragraph">
<p>Oh, ok seems that we&#8217;ve received a response with only Asimov books again, and
sadly no stars. Luckily the protocol rules allows us to still use the response
if we choose to.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#77
body:
  "I, Robot" stars:2
  "The Gods Themselves"
  "Pebble in the Sky" stars:5</pre>
</div>
</div>
<div class="paragraph">
<p>And what is this now. We&#8217;ve consumed yet another response and it appears to be
the Asimov list again, but this time with star-ratings, but only for a few
titles.</p>
</div>
<div class="paragraph">
<p>This is quite normal and shows us a really important and valuable aspect of
the Query/Response pattern. If we would pull the curtain back a bit, it could
be reasonable to assume that the publisher of Asimov books now exists in 2
distinct versions. One supports the new updated format, and has a couple of
star-ratings set. The other appears to be the <em>older</em> version.</p>
</div>
<div class="paragraph">
<p>We have effectively seen how response publishers can evolve, and even exist
side-by-side, if care is taken to design a suitable payload protocol.</p>
</div>
<div class="paragraph">
<p><em>The backward compatibility of the payload format is not at all required in the
 Query/Response pattern. Implementations could use version tags or classifiers
 to check for compatibility at the consumer side.</em></p>
</div>
<div class="paragraph">
<p>The key point here is, the consumer is still responsible for asserting the
usefulness and value of the response information. Parsing, validating or
checking for version compatibility is required.</p>
</div>
</div>
<div class="sect2">
<h3 id="_out_with_the_old">Out with the old</h3>
<div class="paragraph">
<p>Let&#8217;s jump forward and say that at some later time, the query for sci-fi books
is published again.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: books.sci-fi
reply-to: library/books.sci-fi#88</pre>
</div>
</div>
<div class="paragraph">
<p>And this time, the only consumed response with Asimov books is the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>response: library/books.sci-fi#88
body:
  "I, Robot" stars:3
  "The Gods Themselves" stars:3
  "Pebble in the Sky" stars:5</pre>
</div>
</div>
<div class="paragraph">
<p>We can almost certainly conclude that the original version of the Asimov
book service has been shut down.</p>
</div>
<div class="paragraph">
<p>Again we can see how the Query/Response pattern helps in coping with a natural
evolution of the system. Services can be added, removed or upgraded at any
time.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_queryresponse_maturity_model">Query/Response Maturity Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just like with the <a href="https://martinfowler.com/articles/richardsonMaturityModel.html">Richardson Maturity Model</a>, I&#8217;ve identified an
evolution of maturity around the acceptance, use and implementation of
Query/Response. It describes the benefits, opportunities and also
complexities, pretty well.</p>
</div>
<div class="sect2">
<h3 id="_level_0_purgatory">Level 0 - Purgatory</h3>
<div class="paragraph">
<p>All communication and exchange is bound to fixed, configured, service end-
points. Synchronous blocking calls exchange information based on formats
declared in project Wiki-pages or Word-documents. Most solutions are stateless,
with I/O bound performance. Changes typically require system wide,
synchronized, upgrades. This lead to development dropping in velocity, as each
module or team will find it hard or impossible to act independently of each
other.</p>
</div>
</div>
<div class="sect2">
<h3 id="_level_1">Level 1</h3>
<div class="paragraph">
<p>Using the Query/Response pattern for the first time often leads to healthy
temporal decoupling pretty quick. But with a lot of code still written with
a synchronous model in mind, the data exchange tend to look a bit like <em>sync</em>.
Solutions move towards being stateful, but loosen their I/O-bound performance
characteristics. It&#8217;s hard for developer to think about queries and responses
not coming from known components. Already at this level teams and modules gain
a lot in the capability to move independently. Releases and deployment is
practically not a tangle any more, although the view on evolutionary
data-structures or protocols for data, may lag behind and still be
Wiki/Document-based.</p>
</div>
</div>
<div class="sect2">
<h3 id="_level_2">Level 2</h3>
<div class="paragraph">
<p>At this level a deeper insight into the value of a proper data-structure or
protocol for payload, which can evolve as required, is often gained. With
this comes the extended benefit of seamless upgrades and service evolution.
Developers get to experience how responsibilities can move without breaking
or changing any integration code - response publishers can change owners and
location.</p>
</div>
</div>
<div class="sect2">
<h3 id="_level_3">Level 3</h3>
<div class="paragraph">
<p>More and more ideas around reactivity and flexibility begin to take form.
Events can immediately trigger queries which may enrich a local context based
on current needs. This moves the design and use beyond a system using sync,
and durable persistent state, to a more ephemeral and <em>living</em> model. The data
structure of payloads tend to be less bound to strict <em>types</em> and more
malleable <em>data shapes</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_level_4_and_beyond">Level 4 and beyond&#8230;&#8203;</h3>
<div class="paragraph">
<p>Information exchange using the Query/Response pattern allows for almost
limitless evolution of services, or components, no longer bound to versions or
availability. The structure of any data is also very dynamic, information can
be partial, enriched, or come in different sets, from different publishers. No
schema is required at this level, but <em>data shapes</em> are used, which can be
embraced by all collaborators in the architecture. Queries are sent and
responses consumed, sometimes within deliberate timeouts; take-until semantics.
This way modules can provide, and fulfill, explicit SLAs if required.</p>
</div>
<div class="paragraph">
<p><em>This is of course not supposed to be taken too seriously, but the maturity
 levels describes a journey, from a strict and stale model, into one where
 evolution and change is quite normal.</em></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-02 10:21:28 +0200
</div>
</div>
</body>
</html>